---
title: "Cover Crop Data Analysis"
author: "Hayley Brackenridge"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: simplex
    highlight: tango
    toc: TRUE
    toc_depth: 4
---

#Preamble

This markdown contains analysis of data from the Roller-Crimper project conducted in Agassiz BC, St-Jean-sur-Richelieu QC, and Harrow ON in 2019, 2020, and 2021.

#VAR

## Load datasets

There are two data files from this project.

The first, named dat, contains rye stand counts, rye anthesis, rye biomass, rye tillers, rye stem diameter, rye mortality & pop ups after crimping, sweet corn stand, sweet corn height, sweet corn injury, sweet corn VT date, and sweet corn yield for only the core 8 treatments -> W & WF no rye, W rye (no WF rye or 2N).

datw is a version of dat that contains WF treatments for all rye treatments (uneven treatment numbers across locations & years).
datr is a version of datw that contains only rye treatments, no controls.

The second data file, named wdat, contains weed measurement timing, quadrat, count, stage, and biomass. 


```{r load datasets, results='hide', message=FALSE, warning=FALSE, 'load-data-&-packages'}
# load datasets
dat<- read.csv("VAR_All.csv")
str(dat) # view data variables & adjust type as necessary
dat$Plot<- as.factor(dat$Plot)
dat$Rep<- as.factor(dat$Rep)
dat$SR<- as.factor(dat$SR)
dat$VT_date<- as.Date(dat$VT_date, "%Y-%m-%d")
dat$VT_date<- format(dat$VT_date, "%j")
dat$VT_date<- as.integer(dat$VT_date, "%j")

dat<- subset(dat, Nitro=="1") # remove 2N trt
dattrt<- subset(dat, !is.na(dat$Cult)) # dattrt contains only trt plots (no ctrls)

# WF data
datwf<- subset(dat, Weediness=="WF") # datwf contains only WF trts & ctrls
datwftrt<- subset(datwf, !is.na(datwf$Cult)) # datwftrt contains only WF trt plots (no ctrls)

# W data
datw<- subset(dat, Trt_num<9) # datw does not contain WF rye trts
datwtrt<- subset(datw, !(is.na(datw$Cult))) # datwtrt contains only weedy trt plots (no ctrls)

# StJean data w/ W/WF factor
Sdatw<- subset(dattrt, Year!="2019"&Location=="StJean") # subset for only StJean data in 2020 & 2021
Sdatw<- subset(Sdatw, Trt_num==4 | Trt_num==7 | Trt_num==11 | Trt_num==14) # subset for only plots w/ W/WF factor
Sdatw1<- subset(Sdatw, Year=="2020") # contains both cultivars
Sdatw2<- subset(Sdatw, Year=="2021") # contains Std only

# Harrow data w/ W/WF factor
Hdatw<- subset(dattrt, Location=="Harrow"&Year!="2019") # subset for only Harrow data in 2020 & 2021
Hdatw1<- subset(Hdatw, SR=="600") # subset for only H SR to compliment StJean data 2020
Hdatw2<- subset(Hdatw1, Cult=="Standard") # subset for only Std to compliment StJean data 2021

# combine Harrow & StJean data
datw1<- rbind(Hdatw1, Sdatw1) # contains both Harrow & StJean data w/ W/WF factor for S & E @ 600
datw2<- rbind(Hdatw2, Sdatw2) # contains both Harrow & StJean data w/ W/WF factor for S @ 600

# Harrow data WF
Hdatwf<- subset(datwf, Location=="Harrow"&Year!="2019")
Hdatwf1<- subset(Hdatwf, SR=="600"|is.na(Hdatwf$SR))
Hdatwf2<- subset(Hdatwf1, Cult!="Early"|is.na(Hdatwf1$Cult))

# StJean data WF
Sdatwf<- subset(datwf, Year!="2019"&Location=="StJean")
Sdatwf1<- subset(Sdatwf, Year=="2020") # contains both cultivars
Sdatwf2<- subset(Sdatwf, Year=="2021") # contains Std only

# combine Harrow & StJean WF data
datwf1<- rbind(Hdatwf1, Sdatwf1) # contains both Harrow & StJean WF data for both cult @ 600 
datwf2<- rbind(Hdatwf2, Sdatwf2) # contains both Harrow & StJean WF data for S 600

# Harrow data WF trts
Hdatwftrt<- subset(datwftrt, Location=="Harrow"&Year!="2019")
Hdatwftrt1<- subset(Hdatwftrt, SR=="600")
Hdatwftrt2<- subset(Hdatwftrt1, Cult=="Standard")

# StJean data WF trts
Sdatwftrt<- subset(datwftrt, Location=="StJean"&Year!="2019")
Sdatwftrt1<- subset(Sdatwftrt, Year=="2020")
Sdatwftrt2<- subset(Sdatwftrt, Year=="2021")

# combine Harrow & StJean WF trt data
datwftrt1<- rbind(Hdatwftrt1, Sdatwftrt1)
datwftrt2<- rbind(Hdatwftrt2, Sdatwftrt2)




wdat<- read.csv("VAR_Weeds.csv")
str(wdat) # view data variables & adjust type as necessary
wdat$Plot<- as.factor(wdat$Plot)
wdat$Rep<- as.factor(wdat$Rep)
wdat$Trt_num<- as.factor(wdat$Trt_num)
wdat$SR<- as.factor(wdat$SR)

wdat<- subset(wdat, Nitro=="1")

# load packages
library(ggplot2)
library(dplyr)
library(car)
library(lme4)
library(lmerTest)
library(ggpubr)
library(lsmeans)
library(emmeans)
```

The data was subsetted to only include the treatment Nitrogen = 1X


## Analysis

For each variable, a graph was created plotting the variable against cultivar, coloured by seeding rate, and facetted by location & year. This was to get a general sense of the trends in the data & look for any anomalies or potential errors.

From there, a full model was created with cultivar, seeding rate, and location as fixed effects, and rep & year as random effects to test whether the treatments were different from the control. 

The full model was reduced using the function `lmerTest::step()` which applies a backward model reduction approach using the Satterthwaite degrees of freedom method. This function does **not** work on `glmer()` so those required manual reduction.

The simplified model was resaved as `model.x.best`.

A summary table and anova table of the best model was produced to obtain p-values for each fixed effect. 

Model assumptions were tested using a Shapiro-Wilk Test and by visual inspection of the following diagnostic plots of residuals: Predicted vs Actual Residuals, Histogram of Residuals, and Q-Q Plot. 

If model assumptions were not well met, a note has been added and I will further investigate whether a transformation is needed.

If model assumptions were met, `emmeans()` was used to compare treatment & control means.

Then, the control was dropped and the model ran again to test the differences between treatments. 

The process of model reduction, assumption testing, & means comparisons was repeated for the treatment model.


Statistical design is an incomplete RBD with cultivar & seeding rate as factorial, weedy & weed-free no rye plots, & weed-free rye plots for some treatments at some locations. The model is:

Y = $\mu$ + block + cult * SR * Location + (1 | Rep : Year) + e



### Rye biomass

```{r rye biomass}
datw$Rye_wt

# plot of rye biomass by cultivar & seeding rate, separated by location & year
ryewtplot1<- ggplot(subset(datw, Cult=="Standard"|Cult=="Early"), aes(x = SR, y = Rye_wt, fill=Cult)) +
          geom_boxplot() +
          facet_wrap(Year~Location)+
          theme_bw()
print(ryewtplot1)

# model analysis for rye biomass
model.ryewt<- lmer(Rye_wt ~ Cult * SR * Location + ( 1 | Rep:Year), data=datw)
summary(model.ryewt)
anova(model.ryewt)

model.ryewt.best<- get_model(lmerTest::step(model.ryewt, reduce.random=F))
summary(model.ryewt.best)
anova(model.ryewt.best)

# check residuals
resid.model.ryewt<- resid(model.ryewt.best)
pred.model.ryewt<- predict(model.ryewt.best)

# check randomness
plot(pred.model.ryewt, resid.model.ryewt, ylab="Residuals", xlab="Rye Weight", main="Predictecd vs Residuals")

# check normality
hist(resid.model.ryewt, main="Histogram of Residuals", xlab="Rye wt")

qqnorm(resid.model.ryewt) 

# Shapiro-Wilk test
shapiro.test(resid.model.ryewt)
# test assumptions fine

# means
ryewtemmeans1<- emmeans(model.ryewt.best, pairwise ~ Location)
ryewtemmeans1 # Harrow & StJean are not different from each other, Agassiz lower than both
plot(ryewtemmeans1, comparisons=T)

ryewtemmeans2<- emmeans(model.ryewt.best, pairwise ~ SR)
ryewtemmeans2 # 600 > 150, 150 & 300 not different, 300 & 600 not different (no signif diffs when WF rye plots removed)
plot(ryewtemmeans2, comparisons=T)
```


### Rye tillers

```{r rye tillers}
datw$TAv

# plot of rye tillers by cultivar & seeding rate, separated by location & year
tillplot1<- ggplot(subset(datw, Cult=="Standard"|Cult=="Early"), aes(x = Cult, y = TAv, fill=factor(SR))) +
          geom_boxplot() +
          facet_wrap(Year~Location)+
          theme_bw()
print(tillplot1)
# huge outlier -- St Jean 2019 plot 307 (TAv = 14.333)

# model analysis for rye tillering
model.till<- lmer(TAv ~ Cult * SR * Location + ( 1 | Rep:Year), data=datw)
summary(model.till)
anova(model.till)

model.till.best<- get_model(lmerTest::step(model.till, reduce.random=F))
summary(model.till.best)
anova(model.till.best)

# check residuals
resid.model.till<- resid(model.till.best)
pred.model.till<- predict(model.till.best)

# check randomness
plot(pred.model.till, resid.model.till, ylab="Residuals", xlab="Rye tillers", main="Predictecd vs Residuals")

# check normality
hist(resid.model.till, main="Histogram of Residuals", xlab="Rye tillers")
# one value very far to right -> outlier from St Jean 2019 307?

qqnorm(resid.model.till) 

# Shapiro-Wilk test
shapiro.test(resid.model.till)
# test assumptions not okay -> try removing outlier


## hard-removing outlier as quick fix, saving under different dataframe
### large datpoint at StJean 2019 307 TAv=14
max(datw$TAv, na.rm=T)
Toutlier.rm<- datw[-c(grep("14", datw$TAv)),]
# check that data point doesn't exist in new dataset
grep("14", Toutlier.rm$TAv)


# redo above analysis without StJean 2019 307 outlier
# plot of rye tillers by cultivar & seeding rate, separated by location & year
tillplot2<- ggplot(subset(Toutlier.rm, Cult=="Standard"|Cult=="Early"), aes(x = Cult, y = TAv, fill=factor(SR))) +
          geom_boxplot() +
          facet_wrap(Year~Location)+
          theme_bw()
print(tillplot2)
# still  some outliers in Harrow 2020 & 2019 data

# model analysis for rye tillering
model.till2<- lmer(TAv ~ Cult * SR * Location + ( 1 | Rep:Year), data=Toutlier.rm)
summary(model.till2)
anova(model.till2)

model.till.best2<- get_model(lmerTest::step(model.till2, reduce.random=F))
summary(model.till.best2)
anova(model.till.best2)

# check residuals
resid.model.till2<- resid(model.till.best2)
pred.model.till2<- predict(model.till.best2)

# check randomness
plot(pred.model.till2, resid.model.till2, ylab="Residuals", xlab="Rye tillers", main="Predictecd vs Residuals")

# check normality
hist(resid.model.till2, main="Histogram of Residuals", xlab="Rye tillers")

qqnorm(resid.model.till2) 

# Shapiro-Wilk test
shapiro.test(resid.model.till2)
# test assumptions fine

tillemmeans1<- emmeans(model.till.best2, pairwise ~ SR|Location)
tillemmeans1
plot(tillemmeans1, comparisons=T)

tillemmeans2<- emmeans(model.till.best2, pairwise ~ Cult|Location)
tillemmeans2
plot(tillemmeans2, comparisons=T)
```


### Rye stem diameter

```{r rye stem diam}
datw$DiamAv

# plot of rye stem diameter by cultivar & seeding rate, separated by year, Harrow only
diamdat<- subset(datw, Location=="Harrow") # subset data to only include Harrow b/c diameter only measured in Harrow
diamplot1<- ggplot(subset(diamdat, Cult=="Standard"|Cult=="Early"), aes(x = Cult, y = DiamAv, fill=factor(SR))) +
          geom_boxplot() +
          facet_wrap(~Year, ncol=1)+
          theme_bw()
print(diamplot1)

# model analysis for rye stem diameter
model.diam<- lmer(DiamAv ~ Cult * SR + ( 1 | Rep:Year), data=diamdat)
summary(model.diam)
anova(model.diam)

model.diam.best<- get_model(lmerTest::step(model.diam, reduce.random=F))
summary(model.diam.best)
anova(model.diam.best)

# check residuals
resid.model.diam<- resid(model.diam.best)
pred.model.diam<- predict(model.diam.best)

# check randomness
plot(pred.model.diam, resid.model.diam, ylab="Residuals", xlab="Rye stem diameter", main="Predictecd vs Residuals")

# check normality
hist(resid.model.diam, main="Histogram of Residuals", xlab="Rye stem diameter")

qqnorm(resid.model.diam) 

# Shapiro-Wilk test
shapiro.test(resid.model.diam)
# assumptions fine

diamemmeans1<- emmeans(model.diam.best, pairwise ~ Cult)
diamemmeans1
plot(diamemmeans1, comparisons=T)

diamemmeans2<- emmeans(model.diam.best, pairwise ~ SR)
diamemmeans2
plot(diamemmeans2, comparisons=T)
```


### Corn stand

```{r corn stand}
datw$Corn_stand

# plot of corn stand by cultivar & seeding rate, separated by location & year
standplot1<- ggplot(datw, aes(x = Trt_code, y = Corn_stand, fill=factor(SR))) +
          geom_boxplot() +
          facet_wrap(Location~Year)+
          theme_bw()
print(standplot1)
```

``` {r corn stand analysis -- trt vs ctrl}
# model analysis for corn stand 

# test effect of rye
model.stand<- lmer(Corn_stand ~ Trt_code * Location + ( 1 | Rep:Year), data=datw)
summary(model.stand)
anova(model.stand)

model.stand.best<- get_model(lmerTest::step(model.stand, reduce.random=F))
summary(model.stand.best)
Anova(model.stand.best, type="III")

# check residuals
resid.model.stand<- resid(model.stand.best)
pred.model.stand<- predict(model.stand.best)

# check randomness
plot(pred.model.stand, resid.model.stand, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.stand, main="Histogram of Residuals", xlab="Corn stand")
# long tails on left

qqnorm(resid.model.stand) # messy on ends

# Shapiro-Wilk test
shapiro.test(resid.model.stand)
# data assumptions not great... try transformations

standemmeans<- emmeans(model.stand.best, pairwise ~ Trt_code)
standemmeans
plot(standemmeans, comparisons=T)
# some trts higher than W1N
```

```{r corn stand analysis -- trts}
# test effect of trts
model.standtrt<- lmer(Corn_stand ~ Cult * SR * Location + ( 1 | Rep:Year), data=datwtrt)
summary(model.standtrt)
anova(model.standtrt)

model.standtrt.best<- get_model(lmerTest::step(model.standtrt, reduce.random=F))
summary(model.standtrt.best)
Anova(model.standtrt.best, type="III")

# check residuals
resid.model.standtrt<- resid(model.standtrt.best)
pred.model.standtrt<- predict(model.standtrt.best)

# check randomness
plot(pred.model.standtrt, resid.model.standtrt, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.standtrt, main="Histogram of Residuals", xlab="Corn stand")
# long tails on left

qqnorm(resid.model.standtrt) # messy on ends

# Shapiro-Wilk test
shapiro.test(resid.model.standtrt)
# data assumptions not great... try transformations

standremmeans<- emmeans(model.stand.best, pairwise ~ Location)
standremmeans
plot(standremmeans, comparisons=T) # Harrow > Agassiz & StJean

# transformations (none really helped)
model.standtrt2<- lmer((Corn_stand)^1/3 ~ Cult * SR * Location + ( 1 | Rep:Year), data=datwtrt)
summary(model.standtrt2)
anova(model.standtrt2)

model.standtrt.best2<- get_model(lmerTest::step(model.standtrt2, reduce.random=F))
summary(model.standtrt.best2)
Anova(model.standtrt.best2, type="III")

# check residuals
resid.model.standtrt2<- resid(model.standtrt.best2)
pred.model.standtrt2<- predict(model.standtrt.best2)

# check randomness
plot(pred.model.standtrt2, resid.model.standtrt2, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.standtrt2, main="Histogram of Residuals", xlab="Corn stand")
# long tails on left

qqnorm(resid.model.standtrt2) # messy on ends

# Shapiro-Wilk test
shapiro.test(resid.model.standtrt2)

```

```{r corn stand analysis -- w vs wf trts, E & S all SR}
# test effect of w/wf trt -> Harrow E & S, all SR
model.standw<- lmer(Corn_stand ~ Weediness * Cult * SR + ( 1 | Rep:Year), data=Hdatw)
summary(model.standw)
anova(model.standw)

model.standw.best<- get_model(lmerTest::step(model.standw, reduce.random=F))
summary(model.standw.best)
Anova(model.standw.best, type="III")

# check residuals
resid.model.standw<- resid(model.standw.best)
pred.model.standw<- predict(model.standw.best)

# check randomness
plot(pred.model.standw, resid.model.standw, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.standw, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.standw) # messy on ends

# Shapiro-Wilk test
shapiro.test(resid.model.standw)

# no main effects to compare means

# no effect of weediness
```

```{r corn stand analysis -- w vs wf trts, E & S 600}
# test effect of w/wf trt -> Harrow & StJean E & S, 600
model.standw600<- lmer(Corn_stand ~ Weediness * Cult * Location + ( 1 | Rep:Year), data=datw1)
summary(model.standw600)
anova(model.standw600)

model.standw600.best<- get_model(lmerTest::step(model.standw600, reduce.random=F))
summary(model.standw600.best)
Anova(model.standw600.best, type="III")

# check residuals
resid.model.standw600<- resid(model.standw600.best)
pred.model.standw600<- predict(model.standw600.best)

# check randomness
plot(pred.model.standw600, resid.model.standw600, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals") # very separated

# check normality
hist(resid.model.standw600, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.standw600)

# Shapiro-Wilk test
shapiro.test(resid.model.standw600)

# means
standw600emmeans<- emmeans(model.standw600.best, pairwise ~ Location)
standw600emmeans
plot(standw600emmeans, comparisons=T) # Harrow > StJean
# no weediness effect
```

```{r corn stand analysis -- w vs wf trts, S 600}
# test effect of w/wf trt -> StJean S, 600
model.standws<- lmer(Corn_stand ~ Weediness * Location + ( 1 | Rep:Year), data=datw2)
summary(model.standws)
anova(model.standws)

model.standws.best<- get_model(lmerTest::step(model.standws, reduce.random=F))
summary(model.standws.best)
Anova(model.standws.best, type="III")

# check residuals
resid.model.standws<- resid(model.standws.best)
pred.model.standws<- predict(model.standws.best)

# check randomness
plot(pred.model.standws, resid.model.standws, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.standws, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.standws)

# Shapiro-Wilk test
shapiro.test(resid.model.standws)

# no main effects to compare means

# no effect of weediness
```

```{r corn stand analysis -- wf trt vs ctrl, E & S all SR}
# test effect of trts
model.standwf<- lmer(Corn_stand ~ Trt_code + ( 1 | Rep:Year), data=Hdatwf)
summary(model.standwf)
anova(model.standwf)

model.standwf.best<- get_model(lmerTest::step(model.standwf, reduce.random=F))
summary(model.standwf.best)
Anova(model.standwf.best, type="III")

# check residuals
resid.model.standwf<- resid(model.standwf.best)
pred.model.standwf<- predict(model.standwf.best)

# check randomness
plot(pred.model.standwf, resid.model.standwf, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.standwf, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.standwf) 

# Shapiro-Wilk test
shapiro.test(resid.model.standwf)

# no main effects -> WF no rye not diff than trts
```

```{r corn stand analysis -- wf trt vs ctrl, E & S 600}
# test effect of trts
model.standwf600<- lmer(Corn_stand ~ Trt_code * Location + ( 1 | Rep:Year), data=datwf1)
summary(model.standwf600)
anova(model.standwf600)

model.standwf600.best<- get_model(lmerTest::step(model.standwf600, reduce.random=F))
summary(model.standwf600.best)
Anova(model.standwf600.best, type="III")

# check residuals
resid.model.standwf600<- resid(model.standwf600.best)
pred.model.standwf600<- predict(model.standwf600.best)

# check randomness
plot(pred.model.standwf600, resid.model.standwf600, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.standwf600, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.standwf600) 

# Shapiro-Wilk test
shapiro.test(resid.model.standwf600)

# means
standwf600emmeans<- emmeans(model.standwf600.best, pairwise ~ Trt_code*Location)
standwf600emmeans
plot(standwf600emmeans, comparisons=T) # [Harrow E = Harrow S = Harrow NR] > [StJean E = StJean S] > StJean NR, (Harrow NR = StJean E)
```

```{r corn stand analysis -- wf trts vs ctrl, S 600}
# test effect of trts
model.standwfs<- lmer(Corn_stand ~ Trt_code * Location + ( 1 | Rep:Year), data=datwf2)
summary(model.standwfs)
anova(model.standwfs)

model.standwfs.best<- get_model(lmerTest::step(model.standwfs, reduce.random=F))
summary(model.standwfs.best)
Anova(model.standwfs.best, type="III")

# check residuals
resid.model.standwfs<- resid(model.standwfs.best)
pred.model.standwfs<- predict(model.standwfs.best)

# check randomness
plot(pred.model.standwfs, resid.model.standwfs, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.standwfs, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.standwfs) 

# Shapiro-Wilk test
shapiro.test(resid.model.standwfs)

# means
standwfsemmeans<- emmeans(model.standwfs.best, pairwise ~ Trt_code*Location)
standwfsemmeans
plot(standwfsemmeans, comparisons=T) # Harrow S > StJean S, rest =
```

```{r corn stand analysis -- wf trts, E & S all SR}
# test effect within trts
model.standwftrt<- lmer(Corn_stand ~ Cult * SR + ( 1 | Rep:Year), data=Hdatwftrt)
summary(model.standwftrt)
anova(model.standwftrt)

model.standwftrt.best<- get_model(lmerTest::step(model.standwftrt, reduce.random=F))
summary(model.standwftrt.best)
Anova(model.standwftrt.best, type="III")

# check residuals
resid.model.standwftrt<- resid(model.standwftrt.best)
pred.model.standwftrt<- predict(model.standwftrt.best)

# check randomness
plot(pred.model.standwftrt, resid.model.standwftrt, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.standwftrt, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.standwftrt) 

# Shapiro-Wilk test
shapiro.test(resid.model.standwftrt)

# no main effects
```

```{r corn stand analysis -- wf trts, E & S 600}
# test effect within trts
model.standwftrt600<- lmer(Corn_stand ~ Cult * Location + ( 1 | Rep:Year), data=datwftrt1)
summary(model.standwftrt600)
anova(model.standwftrt600)

model.standwftrt600.best<- get_model(lmerTest::step(model.standwftrt600, reduce.random=F))
summary(model.standwftrt600.best)
Anova(model.standwftrt600.best, type="III")

# check residuals
resid.model.standwftrt600<- resid(model.standwftrt600.best)
pred.model.standwftrt600<- predict(model.standwftrt600.best)

# check randomness
plot(pred.model.standwftrt600, resid.model.standwftrt600, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.standwftrt600, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.standwftrt600) 

# Shapiro-Wilk test
shapiro.test(resid.model.standwftrt600)

# means
standwftrt600emmeans<- emmeans(model.standwftrt600.best, pairwise ~ Location)
standwftrt600emmeans
plot(standwftrt600emmeans, comparisons=T) # Harrow > StJean
```


### Corn height

```{r corn ht}
datw$Corn_ht_av

# plot of average corn height by cultivar & seeding rate, separated by location & year
htplot1<- ggplot(datw, aes(x = Trt_code, y = Corn_ht_av, fill=factor(SR))) +
          geom_boxplot() +
          facet_wrap(Location~Year)+
          theme_bw()
print(htplot1)
```

```{r corn ht analysis -- trt vs ctrl}
# test effect of trts vs ctrls
model.ht<- lmer(Corn_ht_av ~ Trt_code * Location + ( 1 | Rep:Year), data=datw)
summary(model.ht)
anova(model.ht)

model.ht.best<- get_model(lmerTest::step(model.ht, reduce.random=F))
summary(model.ht.best)
anova(model.ht.best)

# check residuals
resid.model.ht<- resid(model.ht.best)
pred.model.ht<- predict(model.ht.best)

# check randomness
plot(pred.model.ht, resid.model.ht, ylab="Residuals", xlab="Average corn height", main="Predictecd vs Residuals")

# check normality
hist(resid.model.ht, main="Histogram of Residuals", xlab="Average corn height")

qqnorm(resid.model.ht) # 

# Shapiro-Wilk test
shapiro.test(resid.model.ht)

htemmeans<- emmeans(model.ht.best, pairwise ~ Trt_code)
htemmeans
plot(htemmeans, comparisons=T) # ctrls > trts
```

```{r corn ht analysis -- trts}
# trt effect
model.ht.trt<- lmer(Corn_ht_av ~ Cult * SR * Location + ( 1 | Rep:Year), data=datwtrt)
summary(model.ht.trt)
anova(model.ht.trt)

model.ht.trt.best<- get_model(lmerTest::step(model.ht.trt, reduce.random=F))
summary(model.ht.trt.best)
anova(model.ht.trt.best)

# check residuals
resid.model.httrt<- resid(model.ht.trt.best)
pred.model.httrt<- predict(model.ht.trt.best)

# check randomness
plot(pred.model.httrt, resid.model.httrt, ylab="Residuals", xlab="Average corn height", main="Predictecd vs Residuals")

# check normality
hist(resid.model.httrt, main="Histogram of Residuals", xlab="Average corn height")

qqnorm(resid.model.httrt) # messy on ends

# Shapiro-Wilk test
shapiro.test(resid.model.httrt)

# means
htemmeans1<- emmeans(model.ht.trt.best, pairwise ~ Location)
htemmeans1
plot(htemmeans1, comparisons=T) # Harrow > Agassiz > StJean
```

```{r corn ht analysis -- w vs wf trts, E & S all SR}
# test effect of w/wf trt -> Harrow E & S, all SR
model.htw<- lmer(Corn_ht_av ~ Weediness * Cult * SR + ( 1 | Rep:Year), data=Hdatw)
summary(model.htw)
anova(model.htw)

model.htw.best<- get_model(lmerTest::step(model.htw, reduce.random=F))
summary(model.htw.best)
Anova(model.htw.best, type="III")

# check residuals
resid.model.htw<- resid(model.htw.best)
pred.model.htw<- predict(model.htw.best)

# check randomness
plot(pred.model.htw, resid.model.htw, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.htw, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.htw)

# Shapiro-Wilk test
shapiro.test(resid.model.htw)

# means
htwemmeans<- emmeans(model.htw.best, pairwise ~ Weediness)
htwemmeans
plot(htwemmeans, comparisons=T)

# W > WF
```

```{r corn ht analysis -- w vs wf trts, E & S 600}
# test effect of w/wf trt -> Harrow & StJean E & S, 600
model.htw600<- lmer(Corn_ht_av ~ Weediness * Cult * Location + ( 1 | Rep:Year), data=datw1)
summary(model.htw600)
anova(model.htw600)

model.htw600.best<- get_model(lmerTest::step(model.htw600, reduce.random=F))
summary(model.htw600.best)
Anova(model.htw600.best, type="III")

# check residuals
resid.model.htw600<- resid(model.htw600.best)
pred.model.htw600<- predict(model.htw600.best)

# check randomness
plot(pred.model.htw600, resid.model.htw600, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals") 

# check normality
hist(resid.model.htw600, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.htw600)

# Shapiro-Wilk test
shapiro.test(resid.model.htw600)

# means
htw600emmeans<- emmeans(model.htw600.best, pairwise ~ Location)
htw600emmeans
plot(htw600emmeans, comparisons=T) # Harrow > StJean

htw600emmeans1<- emmeans(model.htw600.best, pairwise ~ Cult)
htw600emmeans1
plot(htw600emmeans1, comparisons=T)

# no weediness effect
```

```{r corn ht analysis -- w vs wf trts, S 600}
# test effect of w/wf trt -> StJean S, 600
model.htws<- lmer(Corn_ht_av ~ Weediness + ( 1 | Rep:Year), data=datw2)
summary(model.htws)
anova(model.htws)

model.htws.best<- get_model(lmerTest::step(model.htws, reduce.random=F))
summary(model.htws.best)
Anova(model.htws.best, type="III")

# check residuals
resid.model.htws<- resid(model.htws.best)
pred.model.htws<- predict(model.htws.best)

# check randomness
plot(pred.model.htws, resid.model.htws, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.htws, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.htws)

# Shapiro-Wilk test
shapiro.test(resid.model.htws)

# no main effects to compare means

# no effect of weediness
```

```{r corn ht analysis -- wf trt vs ctrl, E & S all SR}
# test effect of trts
model.htwf<- lmer(Corn_ht_av ~ Trt_code + ( 1 | Rep:Year), data=Hdatwf)
summary(model.htwf)
anova(model.htwf)

model.htwf.best<- get_model(lmerTest::step(model.htwf, reduce.random=F))
summary(model.htwf.best)
Anova(model.htwf.best, type="III")

# check residuals
resid.model.htwf<- resid(model.htwf.best)
pred.model.htwf<- predict(model.htwf.best)

# check randomness
plot(pred.model.htwf, resid.model.htwf, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.htwf, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.htwf) 

# Shapiro-Wilk test
shapiro.test(resid.model.htwf)

# no main effects -> WF no rye not diff than trts
```

```{r corn ht analysis -- wf trt vs ctrl, E & S 600}
# test effect of trts
model.htwf600<- lmer(Corn_ht_av ~ Trt_code * Location + ( 1 | Rep:Year), data=datwf1)
summary(model.htwf600)
anova(model.htwf600)

model.htwf600.best<- get_model(lmerTest::step(model.htwf600, reduce.random=F))
summary(model.htwf600.best)
Anova(model.htwf600.best, type="III")

# check residuals
resid.model.htwf600<- resid(model.htwf600.best)
pred.model.htwf600<- predict(model.htwf600.best)

# check randomness
plot(pred.model.htwf600, resid.model.htwf600, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.htwf600, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.htwf600) 

# Shapiro-Wilk test
shapiro.test(resid.model.htwf600)

# means
htwf600emmeans<- emmeans(model.htwf600.best, pairwise ~ Location*Trt_code)
htwf600emmeans
plot(htwf600emmeans, comparisons=T) # 
```

```{r corn ht analysis -- wf trt vs ctrl, S 600}
# test effect of trts
model.htwfs<- lmer(Corn_ht_av ~ Trt_code * Location + ( 1 | Rep:Year), data=datwf2)
summary(model.htwfs)
anova(model.htwfs)

model.htwfs.best<- get_model(lmerTest::step(model.htwfs, reduce.random=F))
summary(model.htwfs.best)
Anova(model.htwfs.best, type="III")

# check residuals
resid.model.htwfs<- resid(model.htwfs.best)
pred.model.htwfs<- predict(model.htwfs.best)

# check randomness
plot(pred.model.htwfs, resid.model.htwfs, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.htwfs, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.htwfs) 

# Shapiro-Wilk test
shapiro.test(resid.model.htwfs)

# means
htwfsemmeans<- emmeans(model.htwfs.best, pairwise ~ Location)
htwf600emmeans
plot(htwfsemmeans, comparisons=T) # Harrow > StJean
```

```{r corn ht analysis -- wf trts, E & S all SR}
# test effect of trts
model.htwftrt<- lmer(Corn_ht_av ~ Cult * SR + ( 1 | Rep:Year), data=Hdatwftrt)
summary(model.htwftrt)
anova(model.htwftrt)

model.htwftrt.best<- get_model(lmerTest::step(model.htwftrt, reduce.random=F))
summary(model.htwftrt.best)
Anova(model.htwftrt.best, type="III")

# check residuals
resid.model.htwftrt<- resid(model.htwftrt.best)
pred.model.htwftrt<- predict(model.htwftrt.best)

# check randomness
plot(pred.model.htwftrt, resid.model.htwftrt, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.htwftrt, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.htwftrt) 

# Shapiro-Wilk test
shapiro.test(resid.model.htwftrt)

# no main effects
```

```{r corn ht analysis -- wf trts, E & S 600}
# test effect of trts
model.htwftrt600<- lmer(Corn_ht_av ~ Cult * Location + ( 1 | Rep:Year), data=datwftrt1)
summary(model.htwftrt600)
anova(model.htwftrt600)

model.htwftrt600.best<- get_model(lmerTest::step(model.htwftrt600, reduce.random=F))
summary(model.htwftrt600.best)
Anova(model.htwftrt600.best, type="III")

# check residuals
resid.model.htwftrt600<- resid(model.htwftrt600.best)
pred.model.htwftrt600<- predict(model.htwftrt600.best)

# check randomness
plot(pred.model.htwftrt600, resid.model.htwftrt600, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.htwftrt600, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.htwftrt600) 

# Shapiro-Wilk test
shapiro.test(resid.model.htwftrt600)

# means
htwftrt600emmeans<- emmeans(model.htwftrt600.best, pairwise ~ Cult * Location)
htwftrt600emmeans
plot(htwftrt600emmeans, comparisons=T) # Harrow S = Harrow E > S StJean > E StJean
```


### Marketable corn count

```{r M corn count}
datw$M_count

# plot of marketable cob count by cultivar & seeding rate, separated by location & year
Mplot1<- ggplot(datw, aes(x = Trt_code, y = M_count, fill=factor(SR))) +
          geom_boxplot() +
          facet_wrap(Location~Year)+
          theme_bw()
print(Mplot1)
```

```{r M corn count analysis -- trt vs ctrl}
# model analysis for marketable corn count trts vs ctrls
model.M<- lmer(M_count ~ Trt_code * Location + ( 1 | Rep:Year), data=datw)
summary(model.M)
anova(model.M)

model.M.best<- get_model(lmerTest::step(model.M, reduce.random=F))
summary(model.M.best)
anova(model.M.best)

# check residuals
resid.model.M<- resid(model.M.best)
pred.model.M<- predict(model.M.best)

# check randomness
plot(pred.model.M, resid.model.M, ylab="Residuals", xlab="Marketable cob count", main="Predictecd vs Residuals")
# large separation

# check normality
hist(resid.model.M, main="Histogram of Residuals", xlab="Marketable cob count")
# outlier? -> WF?

qqnorm(resid.model.M) # messy on ends

# Shapiro-Wilk test
shapiro.test(resid.model.M)

# means
Mcountemmeans<- emmeans(model.M.best, pairwise ~ Trt_code)
Mcountemmeans
plot(Mcountemmeans, comparisons=T) # WF > trts & W (W slightly lower than trts, not signif)
```

```{r M corn count analysis -- trts}
# model analysis for marketable corn count trts
model.M.trt<- lmer(M_count ~ Cult * SR * Location + ( 1 | Rep:Year), data=datwtrt)
summary(model.M.trt)
anova(model.M.trt)

model.M.trt.best<- get_model(lmerTest::step(model.M.trt, reduce.random=F))
summary(model.M.trt.best)
anova(model.M.trt.best)

# check residuals
resid.model.Mtrt<- resid(model.M.trt.best)
pred.model.Mtrt<- predict(model.M.trt.best)

# check randomness
plot(pred.model.Mtrt, resid.model.Mtrt, ylab="Residuals", xlab="Marketable cob count", main="Predictecd vs Residuals")

# check normality
hist(resid.model.Mtrt, main="Histogram of Residuals", xlab="Marketable cob count")

qqnorm(resid.model.Mtrt) # messy on ends

# Shapiro-Wilk test
shapiro.test(resid.model.Mtrt)
# not great -> few high values

# means
Mcountemmeans1<- emmeans(model.M.best, pairwise ~ Location)
Mcountemmeans1
plot(Mcountemmeans1, comparisons=T) # Harrow > Agassiz & StJean
```

```{r M corn count analysis -- w vs wf trts, E & S all SR}
# test effect of w/wf trt -> Harrow E & S, all SR
model.Mw<- lmer(M_count ~ Weediness * Cult * SR + ( 1 | Rep:Year), data=Hdatw)
summary(model.Mw)
anova(model.Mw)

model.Mw.best<- get_model(lmerTest::step(model.Mw, reduce.random=F))
summary(model.Mw.best)
Anova(model.Mw.best, type="III")

# check residuals
resid.model.Mw<- resid(model.Mw.best)
pred.model.Mw<- predict(model.Mw.best)

# check randomness
plot(pred.model.Mw, resid.model.Mw, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.Mw, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.Mw)

# Shapiro-Wilk test
shapiro.test(resid.model.Mw)

# means
Mwemmeans<- emmeans(model.Mw.best, pairwise ~ Weediness)
Mwemmeans
plot(Mwemmeans, comparisons=T)

# WF > W
```

```{r Mcorn count analysis -- w vs wf trts, E & S 600}
# test effect of w/wf trt -> Harrow & StJean E & S, 600
model.Mw600<- lmer(M_count ~ Weediness * Cult * Location + ( 1 | Rep:Year), data=datw1)
summary(model.Mw600)
anova(model.Mw600)

model.Mw600.best<- get_model(lmerTest::step(model.Mw600, reduce.random=F))
summary(model.Mw600.best)
Anova(model.Mw600.best, type="III")

# check residuals
resid.model.Mw600<- resid(model.Mw600.best)
pred.model.Mw600<- predict(model.Mw600.best)

# check randomness
plot(pred.model.Mw600, resid.model.Mw600, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals") 

# check normality
hist(resid.model.Mw600, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.Mw600)

# Shapiro-Wilk test
shapiro.test(resid.model.Mw600)

# means
Mw600emmeans<- emmeans(model.Mw600.best, pairwise ~ Location:Weediness)
Mw600emmeans
plot(Mw600emmeans, comparisons=T) # Harrow > StJean

# weediness effect by location:
## Harrow: WF > W, StJean: W > WF
```

```{r M corn count analysis -- w vs wf trts, S 600}
# test effect of w/wf trt -> StJean S, 600
model.Mws<- lmer(M_count ~ Weediness * Location + ( 1 | Rep:Year), data=datw2)
summary(model.Mws)
anova(model.Mws)

model.Mws.best<- get_model(lmerTest::step(model.Mws, reduce.random=F))
summary(model.Mws.best)
Anova(model.Mws.best, type="III")

# check residuals
resid.model.Mws<- resid(model.Mws.best)
pred.model.Mws<- predict(model.Mws.best)

# check randomness
plot(pred.model.Mws, resid.model.Mws, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.Mws, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.Mws)

# Shapiro-Wilk test
shapiro.test(resid.model.Mws)

# means
Mwsemmeans<- emmeans(model.Mws.best, pairwise ~ Location*Weediness)
Mwsemmeans
plot(Mwsemmeans, comparisons=T) # Harrow WF > StJean W & WF & Harrow W
```

```{r M corn count analysis -- wf trt vs ctrl, E & S all SR}
# test effect of trts
model.Mwf<- lmer(M_count ~ Trt_code + ( 1 | Rep:Year), data=Hdatwf)
summary(model.Mwf)
anova(model.Mwf)

model.Mwf.best<- get_model(lmerTest::step(model.Mwf, reduce.random=F))
summary(model.Mwf.best)
Anova(model.Mwf.best, type="III")

# check residuals
resid.model.Mwf<- resid(model.Mwf.best)
pred.model.Mwf<- predict(model.Mwf.best)

# check randomness
plot(pred.model.Mwf, resid.model.Mwf, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.Mwf, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.Mwf) 

# Shapiro-Wilk test
shapiro.test(resid.model.Mwf)

# means
Mwfemmeans<- emmeans(model.Mwf.best, pairwise ~ Trt_code)
Mwfemmeans
plot(Mwfemmeans, comparisons=T) # 
```

```{r M corn count analysis -- wf trt vs ctrl, E & S 600}
# test effect of trts
model.Mwf600<- lmer(M_count ~ Trt_code * Location + ( 1 | Rep:Year), data=datwf1)
summary(model.Mwf600)
anova(model.Mwf)

model.Mwf600.best<- get_model(lmerTest::step(model.Mwf600, reduce.random=F))
summary(model.Mwf600.best)
Anova(model.Mwf600.best, type="III")

# check residuals
resid.model.Mwf600<- resid(model.Mwf600.best)
pred.model.Mwf600<- predict(model.Mwf600.best)

# check randomness
plot(pred.model.Mwf600, resid.model.Mwf600, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.Mwf600, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.Mwf600) 

# Shapiro-Wilk test
shapiro.test(resid.model.Mwf600)

# means
Mwf600emmeans<- emmeans(model.Mwf600.best, pairwise ~ Location)
Mwf600emmeans
plot(Mwf600emmeans, comparisons=T) # Harrow > StJean
```

```{r M corn count analysis -- wf trt vs ctrl, S 600}
# test effect of trts
model.Mwfs<- lmer(M_count ~ Trt_code * Location + ( 1 | Rep:Year), data=datwf2)
summary(model.Mwfs)
anova(model.Mwfs)

model.Mwfs.best<- get_model(lmerTest::step(model.Mwfs, reduce.random=F))
summary(model.Mwfs.best)
Anova(model.Mwf.best, type="III")

# check residuals
resid.model.Mwfs<- resid(model.Mwfs.best)
pred.model.Mwfs<- predict(model.Mwfs.best)

# check randomness
plot(pred.model.Mwfs, resid.model.Mwfs, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.Mwfs, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.Mwfs) 

# Shapiro-Wilk test
shapiro.test(resid.model.Mwfs)

# means
Mwfsemmeans<- emmeans(model.Mwfs.best, pairwise ~ Trt_code*Location)
Mwfsemmeans
plot(Mwfsemmeans, comparisons=T) # Harrow NR & S > StJean NR > StJean S
```

```{r M corn count analysis -- wf trts, E & S all SR}
# test effect of trts
model.Mwftrt<- lmer(M_count ~ Cult * SR + ( 1 | Rep:Year), data=Hdatwftrt)
summary(model.Mwftrt)
anova(model.Mwftrt)

model.Mwftrt.best<- get_model(lmerTest::step(model.Mwftrt, reduce.random=F))
summary(model.Mwftrt.best)
Anova(model.Mwftrt.best, type="III")

# check residuals
resid.model.Mwftrt<- resid(model.Mwftrt.best)
pred.model.Mwftrt<- predict(model.Mwftrt.best)

# check randomness
plot(pred.model.Mwftrt, resid.model.Mwftrt, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.Mwftrt, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.Mwftrt) 

# Shapiro-Wilk test
shapiro.test(resid.model.Mwftrt)

# means
Mwftrtemmeans<- emmeans(model.Mwftrt.best, pairwise ~ Cult)
Mwftrtemmeans
plot(Mwftrtemmeans, comparisons=T) # E > S

Mwftrtemmeans1<- emmeans(model.Mwftrt.best, pairwise ~ SR)
Mwftrtemmeans1
plot(Mwftrtemmeans1, comparisons=T) # 600 > 150
```

```{r M corn count analysis -- wf trts, E & S 600}
# test effect of trts
model.Mwftrt600<- lmer(M_count ~ Cult * Location + ( 1 | Rep:Year), data=datwftrt1)
summary(model.Mwftrt600)
anova(model.Mwftrt600)

model.Mwftrt600.best<- get_model(lmerTest::step(model.Mwftrt600, reduce.random=F))
summary(model.Mwftrt600.best)
Anova(model.Mwftrt600.best, type="III")

# check residuals
resid.model.Mwftrt600<- resid(model.Mwftrt600.best)
pred.model.Mwftrt600<- predict(model.Mwftrt600.best)

# check randomness
plot(pred.model.Mwftrt600, resid.model.Mwftrt600, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.Mwftrt600, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.Mwftrt600) 

# Shapiro-Wilk test
shapiro.test(resid.model.Mwftrt600)

# means
Mwftrt600emmeans<- emmeans(model.Mwftrt600.best, pairwise ~ Location)
Mwftrt600emmeans
plot(Mwftrt600emmeans, comparisons=T) # Harrow > StJean
```


### Marketable corn weight

```{r M corn wt}
# plot of marketable cob weight by cultivar & seeding rate, separated by location & year
Mwtplot1<- ggplot(datw, aes(x = Trt_code, y = M_wt, fill=factor(SR))) +
          geom_boxplot() +
          facet_wrap(Location~Year)+
          theme_bw()
print(Mwtplot1)
```

```{r M corn wt analysis -- trt vs ctrl}
# model analysis for marketable cob weight trt vs ctrl
model.Mwt<- lmer(M_wt ~ Trt_code * Location + ( 1 | Rep:Year), data=datw)
summary(model.Mwt)
anova(model.Mwt)

model.Mwt.best<- get_model(lmerTest::step(model.Mwt, reduce.random=F))
summary(model.Mwt.best)
anova(model.Mwt.best)

# check residuals
resid.model.Mwt<- resid(model.Mwt.best)
pred.model.Mwt<- predict(model.Mwt.best)

# check randomness
plot(pred.model.Mwt, resid.model.Mwt, ylab="Residuals", xlab="Marketable cob weight", main="Predictecd vs Residuals")

# check normality
hist(resid.model.Mwt, main="Histogram of Residuals", xlab="Marketable cob weight")

qqnorm(resid.model.Mwt) # messy on ends

# Shapiro-Wilk test
shapiro.test(resid.model.Mwt)

# means
Mwtemmeans<- emmeans(model.Mwt.best, pairwise ~ Trt_code)
Mwtemmeans
plot(Mwtemmeans, comparisons=T) # WF > trts & W (W slightly lower than trts, not signif)
```

```{r M corn wt analysis -- trts}
# model analysis for marketable cob weight trts
model.Mwt.trt<- lmer(M_wt ~ Cult * SR * Location + ( 1 | Rep:Year), data=datwtrt)
summary(model.Mwt.trt)
anova(model.Mwt.trt)

model.Mwt.trt.best<- get_model(lmerTest::step(model.Mwt.trt, reduce.random=F))
summary(model.Mwt.trt.best)
anova(model.Mwt.trt.best)

# check residuals
resid.model.Mwttrt<- resid(model.Mwt.trt.best)
pred.model.Mwttrt<- predict(model.Mwt.trt.best)

# check randomness
plot(pred.model.Mwttrt, resid.model.Mwttrt, ylab="Residuals", xlab="Marketable cob weight", main="Predictecd vs Residuals")

# check normality
hist(resid.model.Mwttrt, main="Histogram of Residuals", xlab="Marketable cob weight")

qqnorm(resid.model.Mwttrt) #

# Shapiro-Wilk test
shapiro.test(resid.model.Mwttrt)

# means
Mwtemmeans1<- emmeans(model.Mwt.trt.best, pairwise ~ Cult)
Mwtemmeans1
plot(Mwtemmeans1, comparisons=T) # Std > Early

Mwtemmeans2<- emmeans(model.Mwt.trt.best, pairwise ~ Location)
Mwtemmeans2
plot(Mwtemmeans2, comparison=T) # Harrow > Agassiz & StJean
```

```{r M corn wt analysis -- w vs wf trts, E & S all SR}
# test effect of w/wf trt -> Harrow E & S, all SR
model.Mwtw<- lmer(M_wt ~ Weediness * Cult * SR + ( 1 | Rep:Year), data=Hdatw)
summary(model.Mwtw)
anova(model.Mwtw)

model.Mwtw.best<- get_model(lmerTest::step(model.Mwtw, reduce.random=F))
summary(model.Mwtw.best)
Anova(model.Mwtw.best, type="III")

# check residuals
resid.model.Mwtw<- resid(model.Mwtw.best)
pred.model.Mwtw<- predict(model.Mwtw.best)

# check randomness
plot(pred.model.Mwtw, resid.model.Mwtw, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.Mwtw, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.Mwtw)

# Shapiro-Wilk test
shapiro.test(resid.model.Mwtw)

# means
Mwtwemmeans<- emmeans(model.Mwtw.best, pairwise ~ Weediness:Cult)
Mwtwemmeans
plot(Mwtwemmeans, comparisons=T)

# weediness by cultivar interacton:
## Std: WF > W
## Early: WF > W
## W Early = W Std, WF Early = WF
```

```{r M corn wt analysis -- w vs wf trts, E & S 600}
# test effect of w/wf trt -> Harrow & StJean E & S, 600
model.Mwtw600<- lmer(M_wt ~ Weediness * Cult * Location + ( 1 | Rep:Year), data=datw1)
summary(model.Mwtw600)
anova(model.Mwtw600)

model.Mwtw600.best<- get_model(lmerTest::step(model.Mwtw600, reduce.random=F))
summary(model.Mwtw600.best)
Anova(model.Mwtw600.best, type="III")

# check residuals
resid.model.Mwtw600<- resid(model.Mwtw600.best)
pred.model.Mwtw600<- predict(model.Mwtw600.best)

# check randomness
plot(pred.model.Mwtw600, resid.model.Mwtw600, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals") 

# check normality
hist(resid.model.Mwtw600, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.Mwtw600)

# Shapiro-Wilk test
shapiro.test(resid.model.Mwtw600)

# means
Mwtw600emmeans<- emmeans(model.Mwtw600.best, pairwise ~ Location:Weediness)
Mwtw600emmeans
plot(Mwtw600emmeans, comparisons=T) 

# weediness effect by location:
## Harrow: WF > W, StJean: W = WF
```

```{r M corn wt analysis -- w vs wf trts, S 600}
# test effect of w/wf trt -> StJean S, 600
model.Mwtws<- lmer(M_wt ~ Weediness + ( 1 | Rep:Year), data=datw2)
summary(model.Mwtws)
anova(model.Mwtws)

model.Mwtws.best<- get_model(lmerTest::step(model.Mwtws, reduce.random=F))
summary(model.Mwtws.best)
Anova(model.Mwtws.best, type="III")

# check residuals
resid.model.Mwtws<- resid(model.Mwtws.best)
pred.model.Mwtws<- predict(model.Mwtws.best)

# check randomness
plot(pred.model.Mwtws, resid.model.Mwtws, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.Mws, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.Mwtws)

# Shapiro-Wilk test
shapiro.test(resid.model.Mwtws)

# no main effects to compare means

# no effect of weediness
```

```{r M corn wt analysis -- wf trt vs ctrl, E & S all SR}
# test effect of trts
model.Mwtwf<- lmer(M_wt ~ Trt_code + ( 1 | Rep:Year), data=Hdatwf)
summary(model.Mwtwf)
anova(model.Mwtwf)

model.Mwtwf.best<- get_model(lmerTest::step(model.Mwtwf, reduce.random=F))
summary(model.Mwtwf.best)
Anova(model.Mwtwf.best, type="III")

# check residuals
resid.model.Mwtwf<- resid(model.Mwtwf.best)
pred.model.Mwtwf<- predict(model.Mwtwf.best)

# check randomness
plot(pred.model.Mwtwf, resid.model.Mwtwf, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.Mwtwf, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.Mwtwf) 

# Shapiro-Wilk test
shapiro.test(resid.model.Mwtwf)

# no main effects
```

```{r M corn wt analysis -- wf trt vs ctrl, E & S 600}
# test effect of trts
model.Mwt600wf<- lmer(M_wt ~ Trt_code * Location + ( 1 | Rep:Year), data=datwf1)
summary(model.Mwt600wf)
anova(model.Mwt600wf)

model.Mwt600wf.best<- get_model(lmerTest::step(model.Mwt600wf, reduce.random=F))
summary(model.Mwt600wf.best)
Anova(model.Mwt600wf.best, type="III")

# check residuals
resid.model.Mwt600wf<- resid(model.Mwt600wf.best)
pred.model.Mwt600wf<- predict(model.Mwt600wf.best)

# check randomness
plot(pred.model.Mwt600wf, resid.model.Mwt600wf, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.Mwt600wf, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.Mwt600wf) 

# Shapiro-Wilk test
shapiro.test(resid.model.Mwt600wf)

# means
Mwt600wfemmeans<- emmeans(model.Mwt600wf.best, pairwise ~ Location)
Mwt600wfemmeans
plot(Mwt600wfemmeans, comparisons=T) # Harrow > StJean
```

```{r M corn wt analysis -- wf trt vs ctrl, S 600}
# test effect of trts
model.Mwtswf<- lmer(M_wt ~ Trt_code * Location + ( 1 | Rep:Year), data=datwf2)
summary(model.Mwtswf)
anova(model.Mwtswf)

model.Mwtswf.best<- get_model(lmerTest::step(model.Mwtswf, reduce.random=F))
summary(model.Mwtswf.best)
Anova(model.Mwtswf.best, type="III")

# check residuals
resid.model.Mwtswf<- resid(model.Mwtswf.best)
pred.model.Mwtswf<- predict(model.Mwtswf.best)

# check randomness
plot(pred.model.Mwtswf, resid.model.Mwtswf, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.Mwtswf, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.Mwtswf) 

# Shapiro-Wilk test
shapiro.test(resid.model.Mwtswf)

# means
Mwtswfemmeans<- emmeans(model.Mwtswf.best, pairwise ~ Trt_code)
Mwtswfemmeans
plot(Mwtswfemmeans, comparisons=T) # NR > S

Mwtswfemmeans1<- emmeans(model.Mwtswf.best, pairwise ~ Location)
Mwtswfemmeans1
plot(Mwtswfemmeans1, comparisons=T) # Harrow > StJean
```

```{r M corn wt analysis -- wf trts, E & S all SR}
# test effect of trts
model.Mwtwftrt<- lmer(M_wt ~ Cult * SR + ( 1 | Rep:Year), data=Hdatwftrt)
summary(model.Mwtwftrt)
anova(model.Mwtwftrt)

model.Mwtwftrt.best<- get_model(lmerTest::step(model.Mwtwftrt, reduce.random=F))
summary(model.Mwtwftrt.best)
Anova(model.Mwtwftrt.best, type="III")

# check residuals
resid.model.Mwtwftrt<- resid(model.Mwtwftrt.best)
pred.model.Mwtwftrt<- predict(model.Mwtwftrt.best)

# check randomness
plot(pred.model.Mwtwftrt, resid.model.Mwtwftrt, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.Mwtwftrt, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.Mwtwftrt) 

# Shapiro-Wilk test
shapiro.test(resid.model.Mwtwftrt)

# no main effects
```

```{r M corn wt analysis -- wf trts, E & S 600}
# test effect of trts
model.Mwtwftrt600<- lmer(M_wt ~ Cult * Location + ( 1 | Rep:Year), data=datwftrt1)
summary(model.Mwtwftrt600)
anova(model.Mwtwftrt600)

model.Mwtwftrt600.best<- get_model(lmerTest::step(model.Mwtwftrt600, reduce.random=F))
summary(model.Mwtwftrt600.best)
Anova(model.Mwtwftrt600.best, type="III")

# check residuals
resid.model.Mwtwftrt600<- resid(model.Mwtwftrt600.best)
pred.model.Mwtwftrt600<- predict(model.Mwtwftrt600.best)

# check randomness
plot(pred.model.Mwtwftrt600, resid.model.Mwtwftrt600, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.Mwtwftrt600, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.Mwtwftrt600) 

# Shapiro-Wilk test
shapiro.test(resid.model.Mwtwftrt600)

# means
Mwtwftrt600emmeans<- emmeans(model.Mwtwftrt600.best, pairwise ~ Location)
Mwtwftrt600emmeans
plot(Mwtwftrt600emmeans, comparisons=T) # Harrow > StJean
```


### Unmarketable corn count

```{r UM corn count}
# plot of unmarketable cob count by cultivar & seeding rate, separated by location & year
UMplot1<- ggplot(datw, aes(x = Trt_code, y = UM_count, fill=factor(SR))) +
          geom_boxplot() +
          facet_wrap(Location~Year)+
          theme_bw()
print(UMplot1)
```

``` {r UM corn count analysis -- trt vs ctrl}
# model analysis for unmarketable cob count trt vs ctrl
model.UM<- lmer(UM_count ~ Trt_code * Location + ( 1 | Rep:Year), data=datw)
summary(model.UM)
anova(model.UM)

model.UM.best<- get_model(lmerTest::step(model.UM, reduce.random=F))
summary(model.UM.best)
anova(model.UM.best)

# check residuals
resid.model.UM<- resid(model.UM.best)
pred.model.UM<- predict(model.UM.best)

# check randomness
plot(pred.model.UM, resid.model.UM, ylab="Residuals", xlab="Unmarketable cob count", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UM, main="Histogram of Residuals", xlab="Unmarketable cob count")

qqnorm(resid.model.UM) 

# Shapiro-Wilk test
shapiro.test(resid.model.UM)

# means
UMcountemmeans<- emmeans(model.UM.best, pairwise ~ Trt_code)
UMcountemmeans
plot(UMcountemmeans, comparisons=T) # WF > W, S3 > W, Trts = WF
```

```{r UM corn count analysis -- trts}
# model analysis for unmarketable cob count trts
model.UM.trt<- lmer(UM_count ~ Cult * SR * Location + ( 1 | Rep:Year), data=datwtrt)
summary(model.UM.trt)
anova(model.UM.trt)

model.UM.trt.best<- get_model(lmerTest::step(model.UM.trt, reduce.random=F))
summary(model.UM.trt.best)
anova(model.UM.trt.best)

# check residuals
resid.model.UMtrt<- resid(model.UM.trt.best)
pred.model.UMtrt<- predict(model.UM.trt.best)

# check randomness
plot(pred.model.UMtrt, resid.model.UMtrt, ylab="Residuals", xlab="Unmarketable cob count", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMtrt, main="Histogram of Residuals", xlab="Unmarketable cob count")

qqnorm(resid.model.UMtrt) 

# Shapiro-Wilk test
shapiro.test(resid.model.UMtrt)

# means
UMcountemmeans1<- emmeans(model.UM.trt.best, pairwise ~ Cult)
UMcountemmeans1
plot(UMcountemmeans1, comparisons=T) # Std > Early

UMcountemmeans2<- emmeans(model.UM.trt.best, pairwise ~ Location)
UMcountemmeans2
plot(UMcountemmeans2, comparisons=T) # Harrow > Agassiz & StJean
```

```{r UM corn count analysis -- w vs wf trts, E & S all SR}
# test effect of w/wf trt -> Harrow E & S, all SR
model.UMw<- lmer(UM_count ~ Weediness * Cult * SR + ( 1 | Rep:Year), data=Hdatw)
summary(model.UMw)
anova(model.UMw)

model.UMw.best<- get_model(lmerTest::step(model.UMw, reduce.random=F))
summary(model.UMw.best)
Anova(model.UMw.best, type="III")

# check residuals
resid.model.UMw<- resid(model.UMw.best)
pred.model.UMw<- predict(model.UMw.best)

# check randomness
plot(pred.model.UMw, resid.model.UMw, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMw, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.UMw)

# Shapiro-Wilk test
shapiro.test(resid.model.UMw)

# no main effects to compare means

# no effect of weediness
```

```{r UM corn count analysis -- w vs wf trts, E & S 600}
# test effect of w/wf trt -> Harrow & StJean E & S, 600
model.UMw600<- lmer(UM_count ~ Weediness * Cult * Location + ( 1 | Rep:Year), data=datw1)
summary(model.UMw600)
anova(model.UMw600)

model.UMw600.best<- get_model(lmerTest::step(model.UMw600, reduce.random=F))
summary(model.UMw600.best)
Anova(model.UMw600.best, type="III")

# check residuals
resid.model.UMw600<- resid(model.UMw600.best)
pred.model.UMw600<- predict(model.UMw600.best)

# check randomness
plot(pred.model.UMw600, resid.model.UMw600, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals") 

# check normality
hist(resid.model.UMw600, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.UMw600)

# Shapiro-Wilk test
shapiro.test(resid.model.UMw600)

# means
UMw600emmeans<- emmeans(model.UMw600.best, pairwise ~ Weediness:Cult)
UMw600emmeans
plot(UMw600emmeans, comparisons=T) 

UMw600emmeans1<- emmeans(model.UMw600.best, pairwise ~ Location)
UMw600emmeans1
plot(UMw600emmeans1, comparisons=T) # Harrow > StJean


# weediness by cultivar interaction:
## Early: WF > W
## Std: W = WF
```

```{r UM corn count analysis -- w vs wf trts, S 600}
# test effect of w/wf trt -> StJean S, 600
model.UMws<- lmer(UM_count ~ Weediness + ( 1 | Rep:Year), data=datw2)
summary(model.UMws)
anova(model.UMws)

model.UMws.best<- get_model(lmerTest::step(model.UMws, reduce.random=F))
summary(model.UMws.best)
Anova(model.UMws.best, type="III")

# check residuals
resid.model.UMws<- resid(model.UMws.best)
pred.model.UMws<- predict(model.UMws.best)

# check randomness
plot(pred.model.UMws, resid.model.UMws, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMws, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.UMws)

# Shapiro-Wilk test
shapiro.test(resid.model.UMws)

# no main effects to compare means

# no effect of weediness
```

```{r UM corn count analysis -- wf trt vs ctrl, E & S all SR}
# test effect of trts
model.UMwf<- lmer(UM_count ~ Trt_code + ( 1 | Rep:Year), data=Hdatwf)
summary(model.UMwf)
anova(model.UMwf)

model.UMwf.best<- get_model(lmerTest::step(model.UMwf, reduce.random=F))
summary(model.UMwf.best)
Anova(model.UMwf.best, type="III")

# check residuals
resid.model.UMwf<- resid(model.UMwf.best)
pred.model.UMwf<- predict(model.UMwf.best)

# check randomness
plot(pred.model.UMwf, resid.model.UMwf, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMwf, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.UMwf) 

# Shapiro-Wilk test
shapiro.test(resid.model.UMwf)

# no main effects
```

```{r UM corn count analysis -- wf trt vs ctrl, E & S 600}
# test effect of trts
model.UMwf600<- lmer(UM_count ~ Trt_code * Location + ( 1 | Rep:Year), data=datwf1)
summary(model.UMwf600)
anova(model.UMwf)

model.UMwf600.best<- get_model(lmerTest::step(model.UMwf600, reduce.random=F))
summary(model.UMwf600.best)
Anova(model.UMwf600.best, type="III")

# check residuals
resid.model.UMwf600<- resid(model.UMwf600.best)
pred.model.UMwf600<- predict(model.UMwf600.best)

# check randomness
plot(pred.model.UMwf600, resid.model.UMwf600, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMwf600, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.UMwf600) 

# Shapiro-Wilk test
shapiro.test(resid.model.UMwf600)

# means
UMwf600emmeans<- emmeans(model.UMwf600.best, pairwise ~ Location*Trt_code)
UMwf600emmeans
plot(UMwf600emmeans, comparisons=T) # StJean: E > S > NR; Harrow: all =
```

```{r UM corn count analysis -- wf trt vs ctrl, S 600}
# test effect of trts
model.UMwfs<- lmer(UM_count ~ Trt_code * Location + ( 1 | Rep:Year), data=datwf2)
summary(model.UMwfs)
anova(model.UMwfs)

model.UMwfs.best<- get_model(lmerTest::step(model.UMwfs, reduce.random=F))
summary(model.UMwfs.best)
Anova(model.UMwf.best, type="III")

# check residuals
resid.model.UMwfs<- resid(model.UMwfs.best)
pred.model.UMwfs<- predict(model.UMwfs.best)

# check randomness
plot(pred.model.UMwfs, resid.model.UMwfs, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMwfs, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.UMwfs) 

# Shapiro-Wilk test
shapiro.test(resid.model.UMwfs)

# no main effects
```

```{r UM corn count analysis -- wf trts, E & S all SR}
# test effect of trts
model.UMwftrt<- lmer(UM_count ~ Cult * SR + ( 1 | Rep:Year), data=Hdatwftrt)
summary(model.UMwftrt)
anova(model.UMwftrt)

model.UMwftrt.best<- get_model(lmerTest::step(model.UMwftrt, reduce.random=F))
summary(model.UMwftrt.best)
Anova(model.UMwftrt.best, type="III")

# check residuals
resid.model.UMwftrt<- resid(model.UMwftrt.best)
pred.model.UMwftrt<- predict(model.UMwftrt.best)

# check randomness
plot(pred.model.UMwftrt, resid.model.UMwftrt, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMwftrt, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.UMwftrt) 

# Shapiro-Wilk test
shapiro.test(resid.model.UMwftrt)

# no main effects
```

```{r UM corn count analysis -- wf trts, E & S 600}
# test effect of trts
model.UMwftrt600<- lmer(UM_count ~ Cult * Location + ( 1 | Rep:Year), data=datwftrt1)
summary(model.UMwftrt600)
anova(model.UMwftrt600)

model.UMwftrt600.best<- get_model(lmerTest::step(model.UMwftrt600, reduce.random=F))
summary(model.UMwftrt600.best)
Anova(model.UMwftrt600.best, type="III")

# check residuals
resid.model.UMwftrt600<- resid(model.UMwftrt600.best)
pred.model.UMwftrt600<- predict(model.UMwftrt600.best)

# check randomness
plot(pred.model.UMwftrt600, resid.model.UMwftrt600, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMwftrt600, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.UMwftrt600) 

# Shapiro-Wilk test
shapiro.test(resid.model.UMwftrt600)

# means
UMwftrt600emmeans<- emmeans(model.UMwftrt600.best, pairwise ~ Location)
UMwftrt600emmeans
plot(UMwftrt600emmeans, comparisons=T) # Harrow > StJean
```


### Unmarketable corn weight

```{r UM corn wt}
# plot of unmarketable cob weight by cultivar & seeding rate, separated by location & year
UMwtplot1<- ggplot(datw, aes(x = Trt_code, y = UM_wt, fill=factor(SR))) +
          geom_boxplot() +
          facet_wrap(Location~Year)+
          theme_bw()
print(UMwtplot1)
```

```{r UM corn wt analysis -- trt vs ctrl}
# model analysis for unmarketable cob weight trt vs ctrl
model.UMwt<- lmer(UM_wt ~ Trt_code * Location + ( 1 | Rep:Year), data=datw)
summary(model.UMwt)
anova(model.UMwt)

model.UMwt.best<- get_model(lmerTest::step(model.UMwt, reduce.random=F))
summary(model.UMwt.best)
anova(model.UMwt.best)

# check residuals
resid.model.UMwt<- resid(model.UMwt.best)
pred.model.UMwt<- predict(model.UMwt.best)

# check randomness
plot(pred.model.UMwt, resid.model.UMwt, ylab="Residuals", xlab="UnMarketable cob weight", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMwt, main="Histogram of Residuals", xlab="UnMarketable cob weight")

qqnorm(resid.model.UMwt)

# Shapiro-Wilk test
shapiro.test(resid.model.UMwt)

# means
UMwtemmeans<- emmeans(model.UMwt.best, pairwise ~ Trt_code|Location)
UMwtemmeans
plot(UMwtemmeans, comparisons=T) # Agassiz: WF > trts & W, Harrow & StJean all same
```

```{r UM corn wt analysis -- trts}
# model analysis for unmarketable cob weight trt vs ctrl
model.UMwt.trt<- lmer(UM_wt ~ Cult * SR * Location + ( 1 | Rep:Year), data=datwtrt)
summary(model.UMwt.trt)
anova(model.UMwt.trt)

model.UMwt.trt.best<- get_model(lmerTest::step(model.UMwt.trt, reduce.random=F))
summary(model.UMwt.trt.best)
anova(model.UMwt.trt.best)

# check residuals
resid.model.UMwttrt<- resid(model.UMwt.trt.best)
pred.model.UMwttrt<- predict(model.UMwt.trt.best)

# check randomness
plot(pred.model.UMwttrt, resid.model.UMwttrt, ylab="Residuals", xlab="UnMarketable cob weight", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMwttrt, main="Histogram of Residuals", xlab="UnMarketable cob weight")

qqnorm(resid.model.UMwttrt) 

# Shapiro-Wilk test
shapiro.test(resid.model.UMwttrt)

# means
UMwtemmeans1<- emmeans(model.UMwt.trt.best, pairwise ~ Location)
UMwtemmeans1
plot(UMwtemmeans1, comparisons=T) # Harrow & StJean > Agassiz
```

```{r UM corn wt analysis -- w vs wf trts, E & S all SR}
# test effect of w/wf trt -> Harrow E & S, all SR
model.UMwtw<- lmer(UM_wt ~ Weediness * Cult * SR + ( 1 | Rep:Year), data=Hdatw)
summary(model.UMwtw)
anova(model.UMwtw)

model.UMwtw.best<- get_model(lmerTest::step(model.UMwtw, reduce.random=F))
summary(model.UMwtw.best)
Anova(model.UMwtw.best, type="III")

# check residuals
resid.model.UMwtw<- resid(model.UMwtw.best)
pred.model.UMwtw<- predict(model.UMwtw.best)

# check randomness
plot(pred.model.UMwtw, resid.model.UMwtw, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMwtw, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.UMwtw)

# Shapiro-Wilk test
shapiro.test(resid.model.UMwtw)

# possible outlier
hist(Hdatw$UM_wt)
## hard-removing outlier as quick fix, saving under different dataframe
max(Hdatw$UM_wt, na.rm=T)
UMoutlier.rm<- Hdatw[-c(grep("6356", Hdatw$UM_wt)),]
# check that data point doesn't exist in new dataset
grep("6356", UMoutlier.rm$UM_wt)

# analysis again w/o outlier
model.UMwtw2<- lmer(UM_wt ~ Weediness * Cult * SR + ( 1 | Rep:Year), data=UMoutlier.rm)
summary(model.UMwtw2)
anova(model.UMwtw2)

model.UMwtw.best2<- get_model(lmerTest::step(model.UMwtw2, reduce.random=F))
summary(model.UMwtw.best2)
Anova(model.UMwtw.best2, type="III")

# check residuals
resid.model.UMwtw2<- resid(model.UMwtw.best2)
pred.model.UMwtw2<- predict(model.UMwtw.best2)

# check randomness
plot(pred.model.UMwtw2, resid.model.UMwtw2, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMwtw2, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.UMwtw2)

# Shapiro-Wilk test
shapiro.test(resid.model.UMwtw2)
# assumptions fine w/o outlier

# no main effects to compare means

# no effect of weediness
```

```{r UM corn wt analysis -- w vs wf trts, E & S 600}
# test effect of w/wf trt -> Harrow & StJean E & S, 600
model.UMwtw600<- lmer(UM_wt ~ Weediness * Cult * Location + ( 1 | Rep:Year), data=datw1)
summary(model.UMwtw600)
anova(model.UMwtw600)

model.UMwtw600.best<- get_model(lmerTest::step(model.UMwtw600, reduce.random=F))
summary(model.UMwtw600.best)
Anova(model.UMwtw600.best, type="III")

# check residuals
resid.model.UMwtw600<- resid(model.UMwtw600.best)
pred.model.UMwtw600<- predict(model.UMwtw600.best)

# check randomness
plot(pred.model.UMwtw600, resid.model.UMwtw600, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals") 

# check normality
hist(resid.model.UMwtw600, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.UMwtw600)

# Shapiro-Wilk test
shapiro.test(resid.model.UMwtw600)

# means
UMwtw600emmeans<- emmeans(model.UMwtw600.best, pairwise ~ Weediness)
UMwtw600emmeans
plot(UMwtw600emmeans, comparisons=T) 

# WF > W
```

```{r UM corn wt analysis -- w vs wf trts, S 600}
# test effect of w/wf trt -> StJean S, 600
model.UMwtws<- lmer(UM_wt ~ Weediness + ( 1 | Rep:Year), data=datw2)
summary(model.UMwtws)
anova(model.UMwtws)

model.UMwtws.best<- get_model(lmerTest::step(model.UMwtws, reduce.random=F))
summary(model.UMwtws.best)
Anova(model.UMwtws.best, type="III")

# check residuals
resid.model.UMwtws<- resid(model.UMwtws.best)
pred.model.UMwtws<- predict(model.UMwtws.best)

# check randomness
plot(pred.model.UMwtws, resid.model.UMwtws, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMwtws, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.UMwtws)

# Shapiro-Wilk test
shapiro.test(resid.model.UMwtws)

# no main effects to compare means

# no effect of weediness
```

```{r UM corn wt analysis -- wf trt vs ctrl, E & S all SR}
# test effect of trts
model.UMwtwf<- lmer(UM_wt ~ Trt_code + ( 1 | Rep:Year), data=Hdatwf)
summary(model.UMwtwf)
anova(model.UMwtwf)

model.UMwtwf.best<- get_model(lmerTest::step(model.UMwtwf, reduce.random=F))
summary(model.UMwtwf.best)
Anova(model.UMwtwf.best, type="III")

# check residuals
resid.model.UMwtwf<- resid(model.UMwtwf.best)
pred.model.UMwtwf<- predict(model.UMwtwf.best)

# check randomness
plot(pred.model.UMwtwf, resid.model.UMwtwf, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMwtwf, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.UMwtwf) 

# Shapiro-Wilk test
shapiro.test(resid.model.UMwtwf)

# no main effects
```

```{r UM corn wt analysis -- wf trt vs ctrl, E & S 600}
# test effect of trts
model.UMwt600wf<- lmer(UM_wt ~ Trt_code * Location + ( 1 | Rep:Year), data=datwf1)
summary(model.UMwt600wf)
anova(model.UMwt600wf)

model.UMwt600wf.best<- get_model(lmerTest::step(model.UMwt600wf, reduce.random=F))
summary(model.UMwt600wf.best)
Anova(model.UMwt600wf.best, type="III")

# check residuals
resid.model.UMwt600wf<- resid(model.UMwt600wf.best)
pred.model.UMwt600wf<- predict(model.UMwt600wf.best)

# check randomness
plot(pred.model.UMwt600wf, resid.model.UMwt600wf, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMwt600wf, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.UMwt600wf) 

# Shapiro-Wilk test
shapiro.test(resid.model.UMwt600wf)

# means
UMwt600wfemmeans<- emmeans(model.UMwt600wf.best, pairwise ~ Trt_code*Location)
UMwt600wfemmeans
plot(UMwt600wfemmeans, comparisons=T) # StJean NR < rest
```

```{r UM corn wt analysis -- wf trt vs ctrl, S 600}
# test effect of trts
model.UMwtswf<- lmer(UM_wt ~ Trt_code * Location + ( 1 | Rep:Year), data=datwf2)
summary(model.UMwtswf)
anova(model.UMwtswf)

model.UMwtswf.best<- get_model(lmerTest::step(model.UMwtswf, reduce.random=F))
summary(model.UMwtswf.best)
Anova(model.UMwtswf.best, type="III")

# check residuals
resid.model.UMwtswf<- resid(model.UMwtswf.best)
pred.model.UMwtswf<- predict(model.UMwtswf.best)

# check randomness
plot(pred.model.UMwtswf, resid.model.UMwtswf, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMwtswf, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.UMwtswf) 

# Shapiro-Wilk test
shapiro.test(resid.model.UMwtswf)

# means
UMwtswfemmeans<- emmeans(model.Mwtswf.best, pairwise ~ Location)
UMwtswfemmeans
plot(UMwtswfemmeans, comparisons=T) # Harrow > StJean
```

```{r UM corn wt analysis -- wf trts, E & S all SR}
# test effect of trts
model.UMwtwftrt<- lmer(UM_wt ~ Cult * SR + ( 1 | Rep:Year), data=Hdatwftrt)
summary(model.UMwtwftrt)
anova(model.UMwtwftrt)

model.UMwtwftrt.best<- get_model(lmerTest::step(model.UMwtwftrt, reduce.random=F))
summary(model.UMwtwftrt.best)
Anova(model.UMwtwftrt.best, type="III")

# check residuals
resid.model.UMwtwftrt<- resid(model.UMwtwftrt.best)
pred.model.UMwtwftrt<- predict(model.UMwtwftrt.best)

# check randomness
plot(pred.model.UMwtwftrt, resid.model.UMwtwftrt, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMwtwftrt, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.UMwtwftrt) 

# Shapiro-Wilk test
shapiro.test(resid.model.UMwtwftrt)

# no main effects
```

```{r UM corn wt analysis -- wf trts, E & S 600}
# test effect of trts
model.UMwtwftrt600<- lmer(UM_wt ~ Cult * Location + ( 1 | Rep:Year), data=datwftrt1)
summary(model.UMwtwftrt600)
anova(model.UMwtwftrt600)

model.UMwtwftrt600.best<- get_model(lmerTest::step(model.UMwtwftrt600, reduce.random=F))
summary(model.UMwtwftrt600.best)
Anova(model.UMwtwftrt600.best, type="III")

# check residuals
resid.model.UMwtwftrt600<- resid(model.UMwtwftrt600.best)
pred.model.UMwtwftrt600<- predict(model.UMwtwftrt600.best)

# check randomness
plot(pred.model.UMwtwftrt600, resid.model.UMwtwftrt600, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.UMwtwftrt600, main="Histogram of Residuals", xlab="Corn stand")

qqnorm(resid.model.UMwtwftrt600) 

# Shapiro-Wilk test
shapiro.test(resid.model.UMwtwftrt600)

# no main effects
```



### Weeds

#### Counts

```{r}
# table with sums of weed counts & standard deviation for within each combination of year, location, cultivar, seeding rate, and time 
Wtable<-wdat %>%
  group_by(Year, Location, Cult, SR, Time) %>%
  summarize(Sum=sum(Count), SD=sd(Count))

Wtable$Time<- factor(Wtable$Time, levels = c("PRE","28DAT","56DAT")) # reorder Time levels so chronological

# plot sum of weed counts & SD from table against seeding rate, factored by cultivar (shape) & time (colour), facted by location & year
## dodged position for easier reading
Wplot<- ggplot(Wtable, aes(x=SR, y=Sum, colour=factor(Time), shape=factor(Cult))) +
  geom_point(position=position_dodge(0.9), size=3) +
  geom_errorbar(aes(ymin=Sum-SD, ymax=Sum+SD), width=0.2, position=position_dodge(0.9)) +
  facet_wrap(Location~Year) +
  theme_bw()
print(Wplot)

# plot of weed count over time (Pre, 28DAT, 56DAT), factored by Cultivar (point shape) & seeding rate (colour & lines), faceted by location & year
Wplot2<- ggplot(Wtable, aes(x=Time, y=Sum, colour=factor(SR), shape=factor(Cult), group=interaction(SR, Cult))) +
  geom_point(size=3) +
  geom_line() +
  geom_errorbar(aes(ymin=Sum-SD, ymax=Sum+SD), width=0.2) +
  facet_wrap(Location~Year) +
  theme_bw()
print(Wplot2)



# weed count models
## count data so glmer used with poisson distribution
### since repeated measures, plot added as random effect (not nested or cross classified)
model.weedcount<- glmer(Count ~ Cult * SR * Location + (1 | Rep : Year) + (1 | Plot), data=wdat, family = poisson)
summary(model.weedcount)
Anova(model.weedcount, type="III") # note: different anova test used 

# check residuals
resid.model.wcount<- resid(model.weedcount)
pred.model.wcount<- predict(model.weedcount)

# check randomness
plot(pred.model.wcount, resid.model.wcount, ylab="Residuals", xlab="Weed counts", main="Predictecd vs Residuals")
# weird trend

# check normality
hist(resid.model.wcount, main="Histogram of Residuals", xlab="weed counts")
# long tails on right

qqnorm(resid.model.wcount) # curvy shape

# Shapiro-Wilk test
shapiro.test(resid.model.wcount)
# assumptions not met, needs transformations? Or not using right format of data?
```


#### Biomass

```{r error=T}
# table with sums of weed biomass for each combination of year, location, cultivar, seeding rate, & plot
WWsumtable<- subset(wdat, Time=="56DAT") %>%
  group_by(Year, Location, Cult, SR, Plot) %>%
  summarize(WSum=sum(Weight))
# table with mean weed biomass & standard deviation for each combination of year, location, cultivar, & seeding rate (i.e. averaged across reps)
WWmeantable<- WWsumtable %>%
  group_by(Year, Location, Cult, SR) %>%
  summarize(WMean=mean(WSum), WSD=sd(WSum))

WWmeantable$Cult<- factor(WWmeantable$Cult, levels = c("Standard", "Early", "NoRye")) # reorder cultivar levels

WWtable<-subset(wdat, Time=="56DAT") %>%
  group_by(Year, Location, Cult, SR, Plot, Rep, Trt_num) %>%
  summarize(W=sum(Weight), Wsd=sd(Weight))

wplot<- ggplot(WWtable, aes(x = SR, y = W, fill = Cult)) + 
          geom_boxplot() +
          theme_bw()
print(wplot)

wplot<- ggplot(WWtable, aes(x = SR, y = W, fill = Cult)) + 
          geom_boxplot() +
          facet_wrap(Year~Location) +
          theme_bw()
print(wplot)

# plot weed biomass & SD from table of means by cultivar & seeding rate, facetted by location & year
## added in group=interaction(SR, Cult) as suggested from plotly.com/ggplot2/geom_line/
### dodged position used for legibility
WWplot<- ggplot(WWmeantable, aes(x=Cult, y=WMean, colour=factor(SR), group=interaction(SR, Cult))) +
  geom_point(position=position_dodge(0.9), size=3) +
  geom_errorbar(aes(ymin=WMean-WSD, ymax=WMean+WSD), width=0.2, position=position_dodge(0.9)) +
  facet_wrap(Location~Year) + 
  theme_bw()
print(WWplot)



# weed biomass models  
model.ww<- lmer(Weight ~ Cult * SR * Location + (1 | Rep : Year), data=subset(wdat, Time=="56DAT"))
summary(model.ww)
anova(model.ww)

model.ww.best<- get_model(lmerTest::step(model.ww, reduce.random=F))
### says number of rows in use has changed but theres not missing data so not sure why

# is.na(subset(wdat, Time=="56DAT")$Weight) # all F -> no missing weights data
## internet suggests to try na.omit but not sure what data it could be taking out 

# wdat.na.omit<- na.omit(wdat)
## removes all of the data

WWemmeans<- emmeans(model.ww, pairwise ~ Location|Cult)


# try weed biomass data without Harrow 2019 data
datnoH19<- wdat[!(wdat$Location=="Harrow" & wdat$Year=="2019"),]

WWsumtable2<- subset(datnoH19, Time=="56DAT") %>%
  group_by(Year, Location, Cult, SR, Plot, Trt_num) %>%
  summarize(WSum2=sum(Weight))
# table with mean weed biomass & standard deviation for each combination of year, location, cultivar, & seeding rate (i.e. averaged across reps)
WWmeantable2<- WWsumtable2 %>%
  group_by(Year, Location, Cult, SR) %>%
  summarize(WMean2=mean(WSum2), WSD2=sd(WSum2))

WWmeantable2$Cult<- factor(WWmeantable2$Cult, levels = c("Standard", "Elbon", "NoRye")) # reorder cultivar levels
WWsumtable2$Cult<- factor(WWsumtable2$Cult, levels = c("Standard", "Early", "NoRye")) # reorder cultivar levels

# plot weed biomass & SD from table of means by cultivar & seeding rate, facetted by location & year
## added in group=interaction(SR, Cult) as suggested from plotly.com/ggplot2/geom_line/
### dodged position used for legibility
WWplot2<- ggplot(WWmeantable2, aes(x=Cult, y=WMean2, colour=factor(SR), group=interaction(SR, Cult))) +
  geom_point(position=position_dodge(0.9), size=3) +
  geom_errorbar(aes(ymin=WMean2-WSD2, ymax=WMean2+WSD2), width=0.2, position=position_dodge(0.9)) +
  facet_wrap(Location~Year) + 
  theme_bw()
print(WWplot2)

WWplot2<- ggplot(WWsumtable2, aes(x=Trt_num, y=WSum2)) +
  geom_boxplot() +
  facet_wrap(~Location) + 
  theme_bw()
print(WWplot2)

model.ww2<- lmer(Weight ~ Cult * SR * Location + (1 | Rep : Year), data=subset(datnoH19, Time=="56DAT"))
summary(model.ww2)
anova(model.ww2)

model.ww3<- lmer(Weight ~ Location : Cult + Location + Cult + (1 | Rep:Year), data=subset(datnoH19, Time=="56DAT"))

emmeans(model.ww3, pairwise~Cult|Location)

max(WWsumtable2$WSum2)
WWsumtable3<- subset(WWsumtable2, WSum2<550)

WWplot3<- ggplot(WWsumtable3, aes(x=Trt_num, y=WSum2, fill=Trt_num)) +
  geom_boxplot() +
  scale_fill_brewer(palette="OrRd") +
  labs(x="Cultivar and Seeding Rate (seeds m^-2)",y="Weed biomass (g)")+
  scale_x_discrete(labels=c("1"="No Rye","2"="Standard 150","3"="Standard 300","4"="Standard 600","5"="Early 150","6"="Early 300","7"="Early 600")) +
  facet_wrap(~Location) + 
  theme(
    axis.text.x=element_text(angle=90),
    panel.background = element_rect(colour = "black", fill = "white"),
    panel.grid.major = element_line(colour = "lightgrey"),
    legend.position = "none",
    axis.text=element_text(size=14),
    axis.title=element_text(size=14,face="bold"),
    strip.text = element_text(size=14), 
    strip.background = element_rect(fill = "white", colour = "black")
  )
print(WWplot3)
```

Not able to produce a model for weed biomass data... telling me that number of rows in use has changed when I use the step function but there's not missing weight data so not sure why

Can manually perform model reduction but that won't address the underlying problem.

It appears from model.ww that location is the only factor that affects weed biomass.




### Rye 50% anthesis

```{r}
# plot of rye anthesis for each cultivar & location, separated by year
anthplot1<- ggplot(dat, aes(x = Cult, y = Rye_anthesis, colour=factor(Location))) +
  geom_point() +
  facet_wrap(~Year) +
  theme_bw()
print(anthplot1)

# model analysis for rye anthesis
model.anth<- lmer(Rye_anthesis ~ Cult * SR * Location + ( 1 | Rep:Year), data=dat)
summary(model.anth)
anova(model.anth)

model.anth.best<- get_model(lmerTest::step(model.anth, reduce.random=F))
summary(model.anth.best)
anova(model.anth.best)

# check residuals
resid.model.anth<- resid(model.anth.best)
pred.model.anth<- predict(model.anth.best)

# check randomness
plot(pred.model.anth, resid.model.anth, ylab="Residuals", xlab="Rye anthesis", main="Predictecd vs Residuals")

# check normality
hist(resid.model.anth, main="Histogram of Residuals", xlab="Rye anthesis")
# very weird shape

qqnorm(resid.model.anth) 
# staggered

# Shapiro-Wilk test
shapiro.test(resid.model.anth)
# test assumptions not met

# plot of rye anthesis by SR & Cult for Harrow 2019 only (other locations & years only provided single date per cultivar)
anthplot2<- ggplot(subset(dat, Location=="Harrow" & Year =="2019"), aes(x = Rye_anthesis, y = SR, fill=factor(Cult))) +
  geom_boxplot() + 
  theme_bw()
print(anthplot2)
  
anthemmeans<- emmeans(model.anth.best, pairwise ~ Cult|Location)
anthemmeans
plot(anthemmeans, comparisons=T)
# Elbon 4 days earlier in Agassiz, 5.33 days earlier in Harrow, & the same as standard in StJean

mean(subset(dat, Location=="Harrow" & Year=="2019" & Cult=="Elbon")$Rye_anthesis) # 155
mean(subset(dat, Location=="Harrow" & Year=="2019" & Cult=="Standard")$Rye_anthesis) # 157

```


### Corn VT

```{r}
# plot of corn VT stage by treatment code, separated by location & year
vtplot1<- ggplot(dat, aes(x = Trt_code, y = VT_date, fill=factor(Cult))) +
  geom_boxplot() +
  facet_wrap(Location~Year) +
  theme_bw()
print(vtplot1)

# model analysis for corn VT stage
model.vt<- lmer(VT_date ~ Cult * SR * Location + ( 1 | Rep:Year), data=dat)
summary(model.vt)
anova(model.vt)

isSingular(model.vt) # TRUE -> likely only location needed in model



model.vt.best<- get_model(lmerTest::step(model.vt, reduce.random=F)) # not working -> number of rows in use has changed
summary(model.vt.best)
anova(model.vt.best)

```


### Correlation of rye biomass & weed biomass

```{r}
# need dataframe with rye biomass & weed biomass data
WWmeantable # table of Year, Location, Cultivar, Seeding rate, Mean weed biomass (across all reps), standard deviation of the mean

# make table of Mean rye biomass (across all reps) for each Year, Location, Cultivar, Seeding rate, + standard deviation of the mean
RWsumtable<- dat %>%
  group_by(Year, Location, Cult, SR, Plot) %>%
  summarize(RSum=sum(Rye_wt))

RWmeantable<- RWsumtable %>%
  group_by(Year, Location, Cult, SR) %>%
  summarize(RMean=mean(RSum, na.rm=T), RSD=sd(RSum, na.rm=T))

# combine the two tables
RWWtable<- merge(WWmeantable, RWmeantable, by=c("Year", "Location","Cult","SR"))
print(RWWtable)

RWWtable2<- merge(WWsumtable, RWsumtable, by=c("Year","Location","Cult","SR","Plot"))

# correlate rye biomass & weed biomass
RWWplot1<- ggplot(RWWtable, aes(x = RMean, y = WMean, colour=interaction(SR,Cult))) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=WMean-WSD, ymax=WMean+WSD)) +
  geom_errorbarh(aes(xmin=RMean-RSD, xmax=RMean+RSD)) +
  facet_wrap(Location~Year) +
  theme_bw()
print(RWWplot1)

RWWplot2<- ggplot(RWWtable2, aes(x = RSum, y = WSum, colour=interaction(SR,Cult))) +
  geom_point(size=3) +
  facet_wrap(Location~Year) +
  theme_bw()
print(RWWplot2)

RWWplot3<- ggplot(RWWtable2, aes(x = RSum, y = WSum, colour=factor(SR))) +
  geom_point(size=3) +
  facet_wrap(Location~Year) +
  theme_bw()
print(RWWplot3)

RWWplot4<- ggplot(RWWtable2, aes(x = RSum, y = WSum, colour=factor(Cult))) +
  geom_point(size=3) +
  facet_wrap(Location~Year) +
  theme_bw()
print(RWWplot4)

ggscatter(RWWtable2, x = "RSum", y = "WSum", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Rye biomass", ylab = "Weed biomass") +
  facet_wrap(Location~Year)
# significant negative correlation when data pooled but not consistent amongst years & locations

cor.test(RWWtable2$RSum, RWWtable2$WSum, method="pearson")
# can I use cor.test to test correlation for each location & year?

```


### Correlation of corn biomass & weed biomass

```{r}
ggscatter(dat, x = "Rye_wt", y = "M_wt", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Rye biomass", ylab = "Marketable corn biomass") +
  facet_wrap(Location~Year)

ggscatter(dat, x = "Rye_wt", y = "M_wt", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Rye biomass", ylab = "Marketable corn biomass")

cor.test(dat$Rye_wt, dat$M_wt, method="pearson")
# not a significant correlation between corn biomass & rye biomas

MWsumtable<- dat %>%
  group_by(Year, Location, Cult, SR, Plot) %>%
  summarize(MSum=sum(M_wt))

MWWsumtable<- merge(MWsumtable, WWsumtable, by=c("Year","Location","Cult","SR","Plot"))

ggscatter(MWWsumtable, x = "WSum", y = "MSum", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Weed biomass", ylab = "Marketable corn biomass") +
  facet_wrap(Location~Year)
# Harrow 2020 has nice negative relationship

ggscatter(MWWsumtable, x = "WSum", y = "MSum", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Weed biomass", ylab = "Marketable corn biomass")

cor.test(MWWsumtable$WSum, MWWsumtable$MSum, method="pearson")
# not a significant correlation between corn biomass & weed biomass

# correlation between weed biomass & corn biomass, HARROW 2020
ggscatter(subset(MWWsumtable, Location=="Harrow" & Year == "2020"), x = "WSum", y = "MSum", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Weed biomass", ylab = "Marketable corn biomass")

# correlation between weed biomass & corn biomass, AGASSIZ 2019
ggscatter(subset(MWWsumtable, Location=="Agassiz" & Year == "2019"), x = "WSum", y = "MSum", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Weed biomass", ylab = "Marketable corn biomass")

SJtest<- subset(MWWsumtable, Location=="StJean")
cor.test(SJtest$WSum, SJtest$MSum, method="pearson")
```


### Corn biomass by seeding rate

```{r}
Mtable<- dat %>%
  group_by(Year, Location, SR, Weediness) %>%
  summarize(MwtMean=mean(M_wt), MwtSD=sd(M_wt))

ggplot(Mtable, aes(x=SR, y=MwtMean, colour=factor(Weediness))) + 
  geom_point(size=3, position=position_dodge(0.9)) +
  geom_errorbar(aes(ymin=MwtMean-MwtSD, ymax=MwtMean+MwtSD), position=position_dodge(0.9)) +
  facet_wrap(Year~Location) +
  theme_bw()

```


#DIR

## load datasets 

There are two datasets for this analysis -- one containing rye stand & weight, corn injury & yield, etc, & the other containing weed counts, stages, & weights

```{r data, results='hide', message=FALSE, warning=FALSE}
# first dataset containing rye & corn data
dir<- read.csv("20DIR_Master.csv")
dir$Rep<- as.factor(dir$Rep)
# second dataset containing weeds data
dirw<- read.csv("DIR_Weeds.csv")
dirw$Rep<- as.factor(dirw$Rep)
dirw$Trt_num<- as.factor(dirw$Trt_num)

# load packages
library(ggplot2, quietly = TRUE)
library(dplyr, quietly = TRUE)
library(car, quietly = TRUE)
library(lme4, quietly = TRUE)
library(lmerTest, quietly = TRUE)
library(ggpubr, quietly = TRUE)
library(lsmeans, quietly = TRUE)
library(emmeans, quietly = TRUE)
library(rstatix, quietly = TRUE)
library(cAIC4, quietly = TRUE)
```

## analysis

For each variable, a graph was created plotting the variable against rye planting direction & crimping direction (if applicable). This was to get a general sense of the trends in the data & look for any anomalies or potential errors.

From there, a full model was created with rye planting and crimping direction as fixed effects, and rep as a random effect to test whether the treatments were different from the control.

Then, the control was dropped and the model ran again to test the differences between treatments. 

The full model was reduced using the function `lmerTest::step()` which applies a backward model reduction approach using the Satterthwaite degrees of freedom method. This function does **not** work on `glmer()` so those required manual reduction.

The simplified model was resaved as `model.x.best`.

A summary table and anova table of the best model was produced to obtain p-values for each fixed effect. 

Model assumptions were tested using a Shapiro-Wilk Test and by visual inspection of the following diagnostic plots of residuals: Predicted vs Actual Residuals, Histogram of Residuals, and Q-Q Plot. 

If model assumptions were not well met, a note has been added and I will further investigate whether a transformation is needed.

If model assumptions were met, a final graph of the variable plotted with only the significant factors was produced. 

Statistical design is an RCBD with planting & crimping as factorial & weediness as split plot factor. The model is:

Y = $\mu$ + block + trt_plnt + trt_crmp + trt_plnt x trt_crmp + weediness + trt_plnt x trt_crmp x weediness + e


### rye stand

```{r rye stand data modifications, results='hide', message=FALSE, warning=FALSE}
# remove no rye control plots
dirtrt<- subset(dir, Trt_plnt=="E"|Trt_plnt=="N")
# create column with total rye stand
dir$Rye_total_stand<- dir$Rye_back_stand + dir$Rye_front_stand
```

```{r plot rye stand}
# front
ryestandfront<- ggplot(dirtrt, aes(x = Trt_plnt, y = Rye_front_stand)) +
          geom_boxplot() +
          theme_bw()
print(ryestandfront)

# back
ryestandback<- ggplot(dirtrt, aes(x = Trt_plnt, y = Rye_back_stand)) +
          geom_boxplot() +
          theme_bw()
print(ryestandback)

# total
ryestandtotal<- ggplot(dirtrt, aes(x = Trt_plnt, y = (Rye_front_stand+Rye_back_stand))) + 
          geom_boxplot() +
          theme_bw()
print(ryestandtotal)
```

```{r t test rye stand (front vs back)}
# paired sample t test to determine if front stand different from back stand
standtest<- t.test(dir$Rye_front_stand, dir$Rye_back_stand, paired = T)
standtest
# not significantly different so pool
```

```{r plot rye stand rep effect, results='hide', message=FALSE, warning=FALSE}
# front
ryestandfrontrep<- ggplot(dirtrt, aes(x = Rep, y = Rye_front_stand)) +
          geom_boxplot() +
          theme_bw()
print(ryestandfrontrep)

# back
ryestandbackrep<- ggplot(dirtrt, aes(x = Rep, y = Rye_back_stand)) +
          geom_boxplot() +
          theme_bw()
print(ryestandbackrep)

# total
ryestandtotalrep<- ggplot(dirtrt, aes(x = Rep, y = (Rye_front_stand+Rye_back_stand))) +
          geom_boxplot() +
          theme_bw()
print(ryestandtotalrep)

# clear rep effect w/ rep 3 being highest, 1 being lowest

# anova of reps to determine if statistically different
standrep<- anova_test(Rye_total_stand ~ Rep, data=dirtrt)
standrep
# significant 
```

```{r model rye stand, results='hide', message=FALSE, warning=FALSE}
# total
model.stand<- lmer((Rye_front_stand+Rye_back_stand) ~ Trt_plnt + ( 1 | Rep), data=dirtrt)
summary(model.stand)
anova(model.stand)

## model reduction
model.stand.best<- get_model(lmerTest::step(model.stand, reduce.random=F))
summary(model.stand.best)
anova(model.stand.best)
### best model: (Rye_front_stand + Rye_back_stand) ~ (1 | Rep)
```

```{r rye stand model assumptions, results='hide', message=FALSE, warning=FALSE,}
# check residuals
resid.model.stand<- resid(model.stand.best)
pred.model.stand<- predict(model.stand.best)

# check randomness
plot(pred.model.stand, resid.model.stand, ylab="Residuals", xlab="Rye Stand", main="Predictecd vs Residuals")

# check normality
hist(resid.model.stand, main="Histogram of Residuals", xlab="Rye Stand") # a little disrupted

qqnorm(resid.model.stand) 

# Shapiro-Wilk test
shapiro.test(resid.model.stand)
# test assumptions fine
```

```{r rye stand difference of means, results='hide', message=FALSE, warning=FALSE,}
# no signficant main effects to compare means
```


### rye biomass

```{r rye biomass data modifications, results='hide', message=FALSE, warning=FALSE}
# use dirtrt
```

```{r plot rye biomass}
ryewt<- ggplot(dirtrt, aes(x = Trt_plnt, y = Rye_wt)) + 
          geom_boxplot() +
          theme_bw()
print(ryewt)
```

```{r plot rye biomass rep effect, results='hide', message=FALSE, warning=FALSE}
ryewtrep<- ggplot(dirtrt, aes(x = Rep, y = Rye_wt)) +
          geom_boxplot() +
          theme_bw()
print(ryewtrep)

# clear rep effect w/ rep 3 being highest, 1 being lowest (similar to stand)

# anova of reps to determine if statistically different
ryewtrep<- anova_test(Rye_wt ~ Rep, data=dirtrt)
ryewtrep
# not significant
```

```{r model rye biomass, results='hide', message=FALSE, warning=FALSE}
model.ryewt<- lmer(Rye_wt ~ Trt_plnt + ( 1 | Rep), data=dirtrt)
summary(model.ryewt)
anova(model.ryewt)

## model reduction
model.ryewt.best<- get_model(lmerTest::step(model.ryewt, reduce.random=F))
summary(model.ryewt.best)
anova(model.ryewt.best)
### best model: Rye_wt ~ (1 | Rep)
```

```{r rye biomass model assumptions, results='hide', message=FALSE, warning=FALSE}
# check residuals
resid.model.ryewt<- resid(model.ryewt.best)
pred.model.ryewt<- predict(model.ryewt.best)

# check randomness
plot(pred.model.ryewt, resid.model.ryewt, ylab="Residuals", xlab="Rye biomass", main="Predictecd vs Residuals") # some divide

# check normality
hist(resid.model.ryewt, main="Histogram of Residuals", xlab="Rye biomass") 

qqnorm(resid.model.ryewt) 

# Shapiro-Wilk test
shapiro.test(resid.model.ryewt)
# test assumptions fine
```

```{r rye biomass difference of means, results='hide', message=FALSE, warning=FALSE}
# no signficant main effects to compare means
```


### rye pop ups

```{r pop up data modifications, results='hide', message=FALSE, warning=FALSE}
# use dirtrt
# convert pop  up data to long form
dirpop <- dirtrt %>%
  gather(key = "time", value = "popups", Pop_0DAT,Pop_7DAT,Pop_14DAt,Pop_21DAT,Pop_28DAT) %>%
  convert_as_factor(Plot, time)
```

```{r plot rye pop ups}
ryepop<- ggplot(dirpop, aes(x = time, y = popups)) + 
          geom_boxplot() +
          theme_bw()
print(ryepop)
# little difference over time after first week

ryepop<- ggplot(dirpop, aes(x = time, y = popups, fill=factor(Trt_plnt))) + 
          geom_boxplot() +
          theme_bw()
print(ryepop)
# no differences across planting arrangements

ryepop<- ggplot(dirpop, aes(x = time, y = popups, fill=factor(Trt_crmp))) + 
          geom_boxplot() +
          theme_bw()
print(ryepop)
# slightly better crimp when travelling east, possibly dampens over time

ryepop<- ggplot(dirpop, aes(x = time, y = popups, colour=factor(Trt_plnt), shape=Trt_crmp)) + 
          geom_point(position=position_dodge(0.9)) +
          theme_bw()
print(ryepop)
# appears to  be differences across crimping directions but not planting directions
```

```{r plot rye pop up rep effect, results='hide', message=FALSE, warning=FALSE}
ryepoprep<- ggplot(dirpop, aes(x = Rep, y = popups)) +
          geom_boxplot() +
          theme_bw()
print(ryepoprep)
# no sign of rep effect

# anova of reps to determine if statistically different
ryepoprep<- anova_test(popups ~ Rep, data=dirpop)
ryepoprep
# not significant
```

```{r model rye pop ups, results='hide', message=FALSE, warning=FALSE}
# Note: should PLOT be included as a random effect? i.e. (1 | Rep:Plot) ? saw it in online tutorial: https://m-clark.github.io/docs/mixedModels/anovamixed.html
model.pop<- lmer(popups ~ Trt_plnt*Trt_crmp*time + ( 1 | Rep), data=dirpop)
summary(model.pop)
anova(model.pop)

## model reduction
model.pop.best<- get_model(lmerTest::step(model.pop, reduce.random=F))
summary(model.pop.best)
anova(model.pop.best)
### best model: popups ~ Trt_crmp + time + (1 | Rep)
```

```{r rye pop up model assumptions, results='hide', message=FALSE, warning=FALSE}
# check residuals
resid.model.pop<- resid(model.pop.best)
pred.model.pop<- predict(model.pop.best)

# check randomness
plot(pred.model.pop, resid.model.pop, ylab="Residuals", xlab="Rye pop ups", main="Predictecd vs Residuals")

# check normality
hist(resid.model.pop, main="Histogram of Residuals", xlab="Rye pop  ups") 

qqnorm(resid.model.pop) 

# Shapiro-Wilk test
shapiro.test(resid.model.pop)
# test assumptions not great but acceptable
```

```{r rye pop ups difference of means}
popmean1<- emmeans(model.pop.best, pairwise ~ Trt_crmp)
popmean1
# 34.5 less pop ups in East crimped than North crimped

popmean2<- emmeans(model.pop.best, pairwise ~ time)
popmean2
# pop ups at time 0 different from all other times, all other times not different from each other
```


### rye mortality

```{r mortality data modifications, results='hide', message=FALSE, warning=FALSE}
# use dirtrt
# convert mortality data to long form
dirmort <- dirtrt %>%
  gather(key = "time", value = "mort", Mort_7DAT,Mort_14DAT,Mort_21DAT,Mort_28DAT) %>%
  convert_as_factor(Plot, time)
# arrange mortality time in order
dirmort$time<- factor(dirmort$time, levels = c("Mort_7DAT","Mort_14DAT","Mort_21DAT","Mort_28DAT")) 
```

```{r plot rye mortality}
ryemort<- ggplot(dirmort, aes(x = time, y = mort)) + 
          geom_boxplot() +
          theme_bw()
print(ryemort)

ryemort<- ggplot(dirmort, aes(x = time, y = mort, fill=Trt_plnt)) + 
          geom_boxplot() + 
          theme_bw()
print(ryemort)
# mortality higher in North planted than East planted but dampens by 21DAT

ryemort<- ggplot(dirmort, aes(x = time, y = mort, fill=Trt_crmp)) + 
          geom_boxplot() + 
          theme_bw()
print(ryemort)
# mortality higher in East than North 7DAT, then higher in North than East 14DAT, then even at 21 & 28

ryemort<- ggplot(dirmort, aes(x = time, y = mort, fill=factor(Trt_num))) + 
          geom_boxplot() + 
          theme_bw()
print(ryemort)
# 7DAT: order of decreasing mortality = 3, 4, 5, 6; 14DAT: 4, 5, 6&3
## 3 = NN, 4 = NE, 5 = EN, 6 = EE 
# all the same at 21 & 28DAT
```

```{r plot rye mortality rep effect, results='hide', message=FALSE, warning=FALSE}
ryemortrep<- ggplot(dirmort, aes(x = Rep, y = mort)) +
          geom_boxplot() +
          theme_bw()
print(ryemortrep)

# no apparent rep effect

# anova of reps to determine if statistically different
ryemortrep<- anova_test(mort ~ Rep, data=dirmort)
ryemortrep
# not significant
```

```{r model rye mortality, results='hide', message=FALSE, warning=FALSE}
model.mort<- lmer(mort ~ Trt_plnt*Trt_crmp*time + ( 1 | Rep), data=dirmort)
summary(model.mort)
anova(model.mort)

## model reduction
model.mort.best<- get_model(lmerTest::step(model.mort, reduce.random=F))
summary(model.mort.best)
anova(model.mort.best)
### best model: mort ~ Trt_plnt + time + (1 | Rep)
```

```{r rye mortality model assumptions, results='hide', message=FALSE, warning=FALSE}
# check residuals
resid.model.mort<- resid(model.mort.best)
pred.model.mort<- predict(model.mort.best)

# check randomness
plot(pred.model.mort, resid.model.mort, ylab="Residuals", xlab="Rye mortality", main="Predictecd vs Residuals") # some divide

# check normality
hist(resid.model.mort, main="Histogram of Residuals", xlab="Rye mortality") 

qqnorm(resid.model.mort) 

# Shapiro-Wilk test
shapiro.test(resid.model.mort)
# test assumptions not great
```

```{r rye mortality difference of means}
mortmean1<- emmeans(model.mort.best, pairwise ~ Trt_plnt)
mortmean1
# 4.38% better mortality in North than East planting

mortmean2<- emmeans(model.mort.best, pairwise ~ time)
mortmean2
# increasing mortality over timem, all statistically different from each other
```


### corn stand

```{r corn stand data modifications, results='hide', message=FALSE, warning=FALSE,}
# use dir
# make long form for weedy/weed-free
dir2 <- dir %>%
  gather(key = "weediness", value = "stand", W_Corn_stand,	WF_Corn_stand) %>%
  convert_as_factor(Plot, weediness)

dir2$Trt_num<- as.factor(dir2$Trt_num)

# remove control for comparing treatments
dir2trt<- subset(dir2, Trt_plnt=="E"|Trt_plnt=="N")
```

```{r plot corn stand}
cstand<- ggplot(dir2, aes(x = weediness, y = stand)) + 
          geom_boxplot() +
          theme_bw()
print(cstand)

cstand<- ggplot(dir2, aes(x = Trt_plnt, y = stand, fill=weediness)) + 
          geom_boxplot() +
          theme_bw()
print(cstand)
# no apparent planting direction effects

cstand<- ggplot(dir2, aes(x = Trt_crmp, y = stand, fill=weediness)) + 
          geom_boxplot() +
          theme_bw()
print(cstand)
# no apparent crimpng direction effects

cstand<- ggplot(dir2, aes(x = Trt_num, y = stand)) + 
          geom_boxplot() +
          theme_bw()
print(cstand)
# no apparent treatment differences
```

```{r plot corn stand rep effect, results='hide', message=FALSE, warning=FALSE}
cstandrep<- ggplot(dir2, aes(x = Rep, y = stand)) +
          geom_boxplot() +
          theme_bw()
print(cstandrep)

# no apparent rep effects

# anova of reps to determine if statistically different
cstandrep<- anova_test(stand ~ Rep, data=dir2)
cstandrep
# not significant
```

```{r model corn stand trt vs control, results='hide', message=FALSE, warning=FALSE}
# first test if treatments are different from control
model.cstand1<- lmer(stand ~ Trt_num * weediness + ( 1 | Rep), data=dir2)
summary(model.cstand1)
anova(model.cstand1)

## model reduction
model.cstand1.best<- get_model(lmerTest::step(model.cstand1, reduce.random=F))
summary(model.cstand1.best)
anova(model.cstand1.best)
### best model: stand ~ (1 | Rep)

# no difference between treatments & control
```

```{r model corn stand trt level, results='hide', message=FALSE, warning=FALSE}
# test if treatments are different from each other
model.cstand2<- lmer(stand ~ Trt_plnt * Trt_crmp * weediness + ( 1 | Rep), data=dir2trt)
summary(model.cstand2)
anova(model.cstand2)

## model reduction
model.cstand2.best<- get_model(lmerTest::step(model.cstand2, reduce.random=F))
summary(model.cstand2.best)
anova(model.cstand2.best)
### best model: stand ~ (1 | Rep)

# no difference between treatments
```

```{r corn stand model assumptions, results='hide', message=FALSE, warning=FALSE,}
# check residuals
resid.model.cstand<- resid(model.cstand2.best)
pred.model.cstand<- predict(model.cstand2.best)

# check randomness
plot(pred.model.cstand, resid.model.cstand, ylab="Residuals", xlab="Corn stand", main="Predictecd vs Residuals") # all along same line

# check normality
hist(resid.model.cstand, main="Histogram of Residuals", xlab="Corn stand") # almost all same frequency

qqnorm(resid.model.cstand) 

# Shapiro-Wilk test
shapiro.test(resid.model.cstand)
# test assumptions not met bc data is singular, no treatment differences
```

```{r corn stand difference of means, results='hide', message=FALSE, warning=FALSE}
# no signficant main effects to compare means
```


### corn height

```{r height data modifications, results='hide', message=FALSE, warning=FALSE}
# use dir
# make long form for weedy/weed-free
## NOTE: should find a way to merge this with above dirw so only one dataset with weediness in long form
dir3 <- dir %>%
  gather(key = "weediness", value = "height", W_Corn_ht_av,	WF_Corn_ht_av) %>%
  convert_as_factor(Plot, weediness)

dir3$Trt_num<- as.factor(dir3$Trt_num)

# remove control for comparing treatments
dir3trt<- subset(dir3, Trt_plnt=="E"|Trt_plnt=="N")
```

```{r plot corn height}
height<- ggplot(dir3, aes(x = weediness, y = height)) + 
          geom_boxplot() +
          theme_bw()
print(height)
# shorter in weedy

height<- ggplot(dir3, aes(x = Trt_plnt, y = height, fill=weediness)) + 
          geom_boxplot() +
          theme_bw()
print(height)
# no apparent plantind direction effects

height<- ggplot(dir3, aes(x = Trt_crmp, y = height, fill=weediness)) + 
          geom_boxplot() +
          theme_bw()
print(height)
# no apparent crimpng direction effects

height<- ggplot(dir3, aes(x = Trt_num, y = height)) + 
          geom_boxplot() +
          theme_bw()
print(height)
# trts 1 & 2 highest -> no c.c. N & E

height<- ggplot(dir3, aes(x = Trt_num, y = height, fill=weediness)) + 
          geom_boxplot() +
          theme_bw()
print(height)
# weediness only affects control plots so possibly elevating above graph
```

```{r plot corn height rep effect}
heightrep<- ggplot(dir3, aes(x = Rep, y = height)) +
          geom_boxplot() +
          theme_bw()
print(heightrep)

# no apparent rep effects

# anova of reps to determine if statistically different
heightrep<- anova_test(height ~ Rep, data=dir3)
heightrep
# not significant
```

```{r model corn height trt vs control}
# first test if treatments are different from control
model.ht1<- lmer(height ~ Trt_num * weediness + ( 1 | Rep), data=dir3)
summary(model.ht1)
anova(model.ht1)

## model reduction
model.ht1.best<- get_model(lmerTest::step(model.ht1, reduce.random=F))
summary(model.ht1.best)
anova(model.ht1.best)
### best model: height ~ Trt_num * weediness + (1 | Rep)

# test means to see if treatments are different from control
htmean1<- emmeans(model.ht1.best, pairwise ~ Trt_num*weediness)
htmean1
# 1 weedy not different from any weedy
# 1 weed-free not different from any weed-free 
# 2 weedy not different from any weedy
# 2 weed-free different from 3 & 6 (NN & EE)
## control elevating effect of weediness

## probably not significant then? is there a better way to explicitly test this than just looking @ means?
```

```{r model corn height trt level, results='hide', message=FALSE, warning=FALSE}
# test if treatments are different from each other
model.ht2<- lmer(height ~ Trt_plnt * Trt_crmp * weediness + ( 1 | Rep), data=dir3trt)
summary(model.ht2)
anova(model.ht2)

## model reduction
model.ht2.best<- get_model(lmerTest::step(model.ht2, reduce.random=F))
summary(model.ht2.best)
anova(model.ht2.best)
### best model:  height ~ Trt_plnt + Trt_crmp + (1 | Rep) + Trt_plnt:Trt_crmp
```

```{r corn height model assumptions, results='hide', message=FALSE, warning=FALSE}
# check residuals
resid.model.ht<- resid(model.ht2.best)
pred.model.ht<- predict(model.ht2.best)

# check randomness
plot(pred.model.ht, resid.model.ht, ylab="Residuals", xlab="Corn height", main="Predictecd vs Residuals")

# check normality
hist(resid.model.ht, main="Histogram of Residuals", xlab="Corn height")

qqnorm(resid.model.ht) 

# Shapiro-Wilk test
shapiro.test(resid.model.ht)
# test assumptions good
```

```{r corn height difference of means}
htmean2<- emmeans(model.ht2.best, pairwise ~ Trt_plnt)
htmean2
# not significant
# corn planted into rye planted East 0.325cm taller than North rye

htmean3<- emmeans(model.ht2.best, pairwise ~ Trt_crmp)
htmean3
# not significant
# East corn planting & crimping 0.425cm taller than North planting & crimping

htmean4<- emmeans(model.ht2.best, pairwise ~ Trt_plnt*Trt_crmp)
htmean4
# not significant
# NE & EN taller than EE & NN -> i.e. perpendicular taller than parallel
```


### corn injury

Need to figure out how to make data in long form for time & weediness
```{r corn injury data modifications, results='hide', message=FALSE, warning=FALSE}
```

```{r plot corn injury, results='hide', message=FALSE, warning=FALSE}

```

```{r plot corn injury rep effect, results='hide', message=FALSE, warning=FALSE}

```

```{r model corn injury trt vs control, results='hide', message=FALSE, warning=FALSE}

```

```{r model corn injury trt level, results='hide', message=FALSE, warning=FALSE}

```

```{r corn injury model assumptions, results='hide', message=FALSE, warning=FALSE}

```

```{r corn injury difference of means, results='hide', message=FALSE, warning=FALSE}
# 
```


### corn tasseling


### corn marketable count

```{r marketable count data modifications, results='hide', message=FALSE, warning=FALSE}
# use dir
# make long form for weedy/weed-free
dir4 <- dir %>%
  gather(key = "weediness", value = "count", W_M_count,	WF_M_count) %>%
  convert_as_factor(Plot, weediness)

dir4$Trt_num<- as.factor(dir4$Trt_num)

# remove control for comparing treatments
dir4trt<- subset(dir4, Trt_plnt=="E"|Trt_plnt=="N")
```

```{r plot corn marketable count}
mcount<- ggplot(dir4, aes(x = weediness, y = count)) + 
          geom_boxplot() +
          theme_bw()
print(mcount)
# higher count in weed-free

mcount<- ggplot(dir4, aes(x = Trt_plnt, y = count, fill=weediness)) + 
          geom_boxplot() +
          theme_bw()
print(mcount)
# no apparent planting direction effects

mcount<- ggplot(dir4, aes(x = Trt_crmp, y = count, fill=weediness)) + 
          geom_boxplot() +
          theme_bw()
print(mcount)
# no apparent crimpng direction effects

mcount<- ggplot(dir4, aes(x = Trt_num, y = count)) + 
          geom_boxplot() +
          theme_bw()
print(mcount)
# no apparent treatment differences

mcount<- ggplot(dir4, aes(x = Trt_num, y = count, fill=weediness)) + 
          geom_boxplot() +
          theme_bw()
print(mcount)
# weed-free higher in all cases, no other trends evident
```

```{r plot corn marketable yield rep effect, results='hide', message=FALSE, warning=FALSE}
mcountrep<- ggplot(dir4, aes(x = Rep, y = count)) +
          geom_boxplot() +
          theme_bw()
print(mcountrep)
# no apparent rep effects

# anova of reps to determine if statistically different
mcountrep<- anova_test(count ~ Rep, data=dir4)
mcountrep
# not significant
```

```{r model corn marketable count trt vs control}
# first test if treatments are different from control
model.mcount1<- lmer(count ~ Trt_num * weediness + ( 1 | Rep), data=dir4)
summary(model.mcount1)
anova(model.mcount1)

## model reduction
model.mcount1.best<- get_model(lmerTest::step(model.mcount1, reduce.random=F))
summary(model.mcount1.best)
anova(model.mcount1.best)
### best model: count ~ Trt_num * weediness + (1 | Rep)

mcountmean1<- emmeans(model.mcount1.best, pairwise ~ Trt_num*weediness)
mcountmean1
# weedy control 1 lower than weedy trt5
# weedy control 2 lower than weedy trt 3, 5, 6
# weed free ctrl 1 & 2 not diff from wf trts

plot(mcountmean1)
```

```{r model corn marketable count trt level, results='hide', message=FALSE, warning=FALSE}
# test if treatments are different from each other
model.mcount2<- lmer(count ~ Trt_plnt * Trt_crmp * weediness + ( 1 | Rep), data=dir4trt)
summary(model.mcount2)
anova(model.mcount2)

## model reduction
model.mcount2.best<- get_model(lmerTest::step(model.mcount2, reduce.random=F))
summary(model.mcount2.best)
anova(model.mcount2.best)
### best model: count ~ weediness + (1 | Rep)
```

```{r corn marketable count model assumptions, results='hide', message=FALSE, warning=FALSE}
# check residuals
resid.model.mcount<- resid(model.mcount2.best)
pred.model.mcount<- predict(model.mcount2.best)

# check randomness
plot(pred.model.mcount, resid.model.mcount, ylab="Residuals", xlab="Corn marketable count", main="Predictecd vs Residuals") # divided in 2

# check normality
hist(resid.model.mcount, main="Histogram of Residuals", xlab="Corn marketable count") 

qqnorm(resid.model.mcount) 

# Shapiro-Wilk test
shapiro.test(resid.model.mcount)
# test assumptions met
```

```{r corn marketable count difference of means}
mcountmean2<- emmeans(model.mcount2.best, pairwise ~ weediness)
mcountmean2
# 8.69 more marketable cobs in weed-free than weedy
```


### corn marketable weight

```{r marketable weight data modifications, results='hide', message=FALSE, warning=FALSE}
# use dir
# make long form for weedy/weed-free
dir5 <- dir %>%
  gather(key = "weediness", value = "weight", W_M_wt,	WF_M_wt) %>%
  convert_as_factor(Plot, weediness)

dir5$Trt_num<- as.factor(dir5$Trt_num)

# remove control for comparing treatments
dir5trt<- subset(dir5, Trt_plnt=="E"|Trt_plnt=="N")
```

```{r plot corn marketable weight}
mwt<- ggplot(dir5, aes(x = weediness, y = weight)) + 
          geom_boxplot() +
          theme_bw()
print(mwt)
# higher weight in weed-free

mwt<- ggplot(dir5, aes(x = Trt_plnt, y = weight, fill=weediness)) + 
          geom_boxplot() +
          theme_bw()
print(mwt)
# no apparent planting direction effects

mwt<- ggplot(dir5, aes(x = Trt_crmp, y = weight, fill=weediness)) + 
          geom_boxplot() +
          theme_bw()
print(mwt)
# no apparent crimpng direction effects

mwt<- ggplot(dir5, aes(x = Trt_num, y = weight)) + 
          geom_boxplot() +
          theme_bw()
print(mwt)
# no apparent treatment differences

mwt<- ggplot(dir5, aes(x = Trt_num, y = weight, fill=weediness)) + 
          geom_boxplot() +
          theme_bw()
print(mwt)
# weed-free higher in all cases, no other trends evident
```

```{r plot corn marketable weight rep effect, results='hide', message=FALSE, warning=FALSE}
mwtrep<- ggplot(dir5, aes(x = Rep, y = weight)) +
          geom_boxplot() +
          theme_bw()
print(mwtrep)
# no apparent rep effects

# anova of reps to determine if statistically different
mwtrep<- anova_test(weight ~ Rep, data=dir5)
mwtrep
# not significant
```

```{r model corn marketable weight trt vs control}
# first test if treatments are different from control
model.mwt1<- lmer(weight ~ Trt_num * weediness + ( 1 | Rep), data=dir5)
summary(model.mwt1)
anova(model.mwt1)

## model reduction
model.mwt1.best<- get_model(lmerTest::step(model.mwt1, reduce.random=F))
summary(model.mwt1.best)
anova(model.mwt1.best)
### best model: weight ~ Trt_num * weediness + (1 | Rep)

mwtmean1<- emmeans(model.mwt1.best, pairwise ~ Trt_num*weediness)
mwtmean1
# weedy control 1 lower than weedy trt5
# weedy control 2 lower than weedy trt 3, 5, 6
# weed free ctrl 1 & 2 higher than all other wf trts

plot(mwtmean1)
# seems to be measurable affect of rye cover crop
## evident by difference in weed-free yield
### also East-planted corn did worse in weedy than North
```

```{r model corn marketable weight trt level, results='hide', message=FALSE, warning=FALSE}
# test if treatments are different from each other
model.mwt2<- lmer(weight ~ Trt_plnt * Trt_crmp * weediness + ( 1 | Rep), data=dir5trt)
summary(model.mwt2)
anova(model.mwt2)

## model reduction
model.mwt2.best<- get_model(lmerTest::step(model.mwt2, reduce.random=F))
summary(model.mwt2.best)
anova(model.mwt2.best)
### best model: weight ~ weediness + (1 | Rep)
```

```{r corn marketable weight model assumptions, results='hide', message=FALSE, warning=FALSE}
# check residuals
resid.model.mwt<- resid(model.mwt2.best)
pred.model.mwt<- predict(model.mwt2.best)

# check randomness
plot(pred.model.mwt, resid.model.mwt, ylab="Residuals", xlab="Corn marketable weight", main="Predictecd vs Residuals") # divided in 2

# check normality
hist(resid.model.mwt, main="Histogram of Residuals", xlab="Corn marketable weight") 

qqnorm(resid.model.mwt) 

# Shapiro-Wilk test
shapiro.test(resid.model.mwt)
# test assumptions met
```

```{r corn marketable weight difference of means}
mwtmean2<- emmeans(model.mwt2.best, pairwise ~ weediness)
mwtmean2
# 2.13 more marketable weight in weed-free than weedy
```


### corn unmarketable count

```{r unmarketable count data modifications, results='hide', message=FALSE, warning=FALSE}
# use dir
# make long form for weedy/weed-free
dir6 <- dir %>%
  gather(key = "weediness", value = "count", W_UM_count,	WF_UM_count) %>%
  convert_as_factor(Plot, weediness)

dir6$Trt_num<- as.factor(dir6$Trt_num)

# remove control for comparing treatments
dir6trt<- subset(dir6, Trt_plnt=="E"|Trt_plnt=="N")
```

```{r plot corn unmarketable count}
umcount<- ggplot(dir6, aes(x = weediness, y = count)) + 
          geom_boxplot() +
          theme_bw()
print(umcount)
# higher count in weed-free

umcount<- ggplot(dir6, aes(x = Trt_plnt, y = count, fill=weediness)) + 
          geom_boxplot() +
          theme_bw()
print(umcount)
# no apparent planting direction effects

umcount<- ggplot(dir6, aes(x = Trt_crmp, y = count, fill=weediness)) + 
          geom_boxplot() +
          theme_bw()
print(umcount)
# no apparent crimpng direction effects

umcount<- ggplot(dir6, aes(x = Trt_num, y = count)) + 
          geom_boxplot() +
          theme_bw()
print(umcount)
# no apparent treatment differences

umcount<- ggplot(dir6, aes(x = Trt_num, y = count, fill=weediness)) + 
          geom_boxplot() +
          theme_bw()
print(umcount)
# weed-free higher in controls but not in trts, lower in wf trts than wf ctrls, lower in w ctrls than w trts
# might be evidence of later maturity in cover crop
```

```{r plot corn unmarketable count rep effect, results='hide', message=FALSE, warning=FALSE}
umcountrep<- ggplot(dir6, aes(x = Rep, y = count)) +
          geom_boxplot() +
          theme_bw()
print(umcountrep)
# no apparent rep effects

# anova of reps to determine if statistically different
umcountrep<- anova_test(count ~ Rep, data=dir6)
umcountrep
# not significant
```

```{r model corn unmarketable count trt vs control}
# first test if treatments are different from control
model.umcount1<- lmer(count ~ Trt_num * weediness + ( 1 | Rep), data=dir6)
summary(model.umcount1)
anova(model.umcount1)

## model reduction
model.umcount1.best<- get_model(lmerTest::step(model.umcount1, reduce.random=F))
summary(model.umcount1.best)
anova(model.umcount1.best)
### best model: count ~ Trt_num * weediness + (1 | Rep)

umcountmean1<- emmeans(model.umcount1.best, pairwise ~ Trt_num*weediness)
umcountmean1
# weedy & wf ctrls not diff from weedy & wf trts
# highest weedy means in 3, 4, 6
# highest wf means in 1, 2, 3

plot(umcountmean1)
```

```{r model corn unmarketable count trt level, results='hide', message=FALSE, warning=FALSE}
# test if treatments are different from each other
model.umcount2<- lmer(count ~ Trt_plnt * Trt_crmp * weediness + ( 1 | Rep), data=dir6trt)
summary(model.umcount2)
anova(model.umcount2)

## model reduction
model.umcount2.best<- get_model(lmerTest::step(model.umcount2, reduce.random=F))
summary(model.umcount2.best)
anova(model.umcount2.best)
### best model: count ~ (1 | Rep)
```

```{r corn unmarketable count model assumptions, results='hide', message=FALSE, warning=FALSE}
# check residuals
resid.model.umcount<- resid(model.umcount2.best)
pred.model.umcount<- predict(model.umcount2.best)

# check randomness
plot(pred.model.umcount, resid.model.umcount, ylab="Residuals", xlab="Corn unmarketable count", main="Predictecd vs Residuals") 

# check normality
hist(resid.model.umcount, main="Histogram of Residuals", xlab="Corn unmarketable count") 

qqnorm(resid.model.umcount) 

# Shapiro-Wilk test
shapiro.test(resid.model.umcount)
# test assumptions met
```

```{r corn unmarketable count difference of means}
# no main effects
```


### corn unmarketable weight

```{r unmarketable weight data modifications, results='hide', message=FALSE, warning=FALSE}
# use dir
# make long form for weedy/weed-free
dir7 <- dir %>%
  gather(key = "weediness", value = "weight", W_UM_wt,	WF_UM_wt) %>%
  convert_as_factor(Plot, weediness)

dir7$Trt_num<- as.factor(dir7$Trt_num)

# remove control for comparing treatments
dir7trt<- subset(dir7, Trt_plnt=="E"|Trt_plnt=="N")
```

```{r plot corn unmarketable weight}
umwt<- ggplot(dir7, aes(x = weediness, y = weight)) + 
          geom_boxplot() +
          theme_bw()
print(umwt)
# higher weight in weed-free

umwt<- ggplot(dir7, aes(x = Trt_plnt, y = weight, fill=weediness)) + 
          geom_boxplot() +
          theme_bw()
print(umwt)
# slightly higher in north rye planted?

umwt<- ggplot(dir7, aes(x = Trt_crmp, y = weight, fill=weediness)) + 
          geom_boxplot() +
          theme_bw()
print(umwt)
# no apparent crimpng direction effects

umwt<- ggplot(dir7, aes(x = Trt_num, y = weight)) + 
          geom_boxplot() +
          theme_bw()
print(umwt)
# no apparent treatment differences

umwt<- ggplot(dir7, aes(x = Trt_num, y = weight, fill=weediness)) + 
          geom_boxplot() +
          theme_bw()
print(umwt)
# weed-free higher in most cases, more in wf ctrls than wf trts, more in w trts than w ctrls
```

```{r plot corn unmarketable weight rep effect, results='hide', message=FALSE, warning=FALSE}
umwtrep<- ggplot(dir7, aes(x = Rep, y = weight)) +
          geom_boxplot() +
          theme_bw()
print(umwtrep)
# no apparent rep effects

# anova of reps to determine if statistically different
umwtrep<- anova_test(weight ~ Rep, data=dir7)
umwtrep
# not significant
```

```{r model corn unmarketable weight trt vs control}
# first test if treatments are different from control
model.umwt1<- lmer(weight ~ Trt_num * weediness + ( 1 | Rep), data=dir7)
summary(model.umwt1)
anova(model.umwt1)

## model reduction
model.umwt1.best<- get_model(lmerTest::step(model.umwt1, reduce.random=F))
summary(model.umwt1.best)
anova(model.umwt1.best)
### best model: weight ~ Trt_num * weediness + (1 | Rep)

umwtmean1<- emmeans(model.umwt1.best, pairwise ~ Trt_num*weediness)
umwtmean1
# weedy ctrl 1 lower than weedy trt 4
# weedy ctrl 2 not diff from weedy trts
# wf ctrls not diff from wf trts

plot(umwtmean1)
# trend almost reverses for wf vs weedy
```

```{r model corn unmarketable weight trt level, results='hide', message=FALSE, warning=FALSE}
# test if treatments are different from each other
model.umwt2<- lmer(weight ~ Trt_plnt * Trt_crmp * weediness + ( 1 | Rep), data=dir7trt)
summary(model.umwt2)
anova(model.umwt2)

## model reduction
model.umwt2.best<- get_model(lmerTest::step(model.umwt2, reduce.random=F))
summary(model.umwt2.best)
anova(model.umwt2.best)
### best model: weight ~ Trt_plnt + (1 | Rep)
```

```{r corn unmarketable weight model assumptions, results='hide', message=FALSE, warning=FALSE}
# check residuals
resid.model.umwt<- resid(model.umwt2.best)
pred.model.umwt<- predict(model.umwt2.best)

# check randomness
plot(pred.model.umwt, resid.model.umwt, ylab="Residuals", xlab="Corn unmarketable weight", main="Predictecd vs Residuals") # divided in 2

# check normality
hist(resid.model.umwt, main="Histogram of Residuals", xlab="Corn unmarketable weight") # not normal 

qqnorm(resid.model.umwt) 

# Shapiro-Wilk test
shapiro.test(resid.model.umwt)
# test assumptions mostly met
```

```{r corn unmarketable weight difference of means}
umwtmean2<- emmeans(model.umwt2.best, pairwise ~ Trt_plnt)
umwtmean2
# 0.278kg more unmarketable weight in North planted rye than East
# no idea why that would be...
```


### total weed count

```{r weed count data modifications, results='hide', message=FALSE, warning=FALSE}
# table with sums of weed counts & standard deviation for within each combination of rye planting direction, rye crimping/corn planting direction, and time 
wtab<-dirw %>%
  group_by(Plot, Rep, Trt_num, Trt_plnt, Trt_crmp, Time) %>%
  summarize(CountSum=sum(Count), SD=sd(Count))

wtab$Time<- factor(wtab$Time, levels = c("PRE","28DAT","56DAT")) # reorder Time levels so chronological

wtab<- wtab[-73,] # weird row at end containing NAs -> need to find source

wtabtrt<- subset(wtab, Trt_plnt=="E"|Trt_plnt=="N")
```

```{r plot weed counts}
weed<- ggplot(wtab, aes(x = Trt_plnt, y = CountSum)) + 
          geom_boxplot() +
          theme_bw()
print(weed)

weed<- ggplot(wtab, aes(x = Trt_crmp, y = CountSum)) + 
          geom_boxplot() +
          theme_bw()
print(weed)

weed<- ggplot(wtab, aes(x = Trt_plnt, y = CountSum, fill = Trt_crmp)) + 
          geom_boxplot() +
          theme_bw()
print(weed)

weed<- ggplot(wtab, aes(x = Time, y = CountSum, fill = Trt_plnt)) + 
          geom_boxplot() +
          theme_bw()
print(weed)

weed<- ggplot(wtab, aes(x = Time, y = CountSum, fill = Trt_crmp)) + 
          geom_boxplot() +
          theme_bw()
print(weed)

weed<- ggplot(wtab, aes(x = Time, y = CountSum, fill = Trt_num)) + 
          geom_boxplot() +
          theme_bw()
print(weed)
# no apparent treatment effects at any time, but all lower & less variation than ctrls
```

```{r plot weed count rep effect, results='hide', message=FALSE, warning=FALSE}
weedrep<- ggplot(wtab, aes(x = Rep, y = CountSum)) +
          geom_boxplot() +
          theme_bw()
print(weedrep)
# no apparent rep effects

# anova of reps to determine if statistically different
# weedrep<- anova_test(CountSum ~ Rep, data=wtab) 
# not working for some reason
# weedrep
# 
```

```{r model weed count trt vs control}
# first test if treatments are different from control
model.wcount1<- glmer(CountSum ~ Trt_num * Time + ( 1 | Rep) + (1 | Plot), data=wtab, family=poisson)
summary(model.wcount1)
Anova(model.wcount1, type="III")

wcountmean1<- emmeans(model.wcount1, pairwise ~ Trt_num * Time)
wcountmean1
# diffs btwn ctrls & trts PRE
# no diffs btwn ctrls & trts 28DAT & 56DAT

plot(wcountmean1)
```

```{r model weed count trt level, results='hide', message=FALSE, warning=FALSE}
# test if treatments are different from each other
model.wcount2<- glmer(CountSum ~ Trt_plnt * Trt_crmp * Time + ( 1 | Rep) + (1 | Plot), data=wtabtrt, family=poisson)
summary(model.wcount2) # AIC = 432.8
Anova(model.wcount2, type="III")

# model reduction
step<- stepcAIC(model.wcount2, data=wtabtrt, trace=T, direction="backward", returnResult=T)

# best model: CountSum ~ Trt_plnt + Trt_crmp + Time + (1 | Plot) + (1 | Rep)

model.wcount2.best<- glmer(CountSum ~ Trt_plnt + Trt_crmp + Time + (1 | Plot) + (1 | Rep), data=wtabtrt, family=poisson)
```

```{r weed count model assumptions, results='hide', message=FALSE, warning=FALSE}
# check residuals
resid.model.wcount<- resid(model.wcount2.best)
pred.model.wcount<- predict(model.wcount2.best)

# check randomness
plot(pred.model.wcount, resid.model.wcount, ylab="Residuals", xlab="Weed counts", main="Predictecd vs Residuals")

# check normality
hist(resid.model.wcount, main="Histogram of Residuals", xlab="Weed counts") # not quite normal but no patterned skewness

qqnorm(resid.model.wcount) 

# Shapiro-Wilk test
shapiro.test(resid.model.wcount)
# test assumptions mostly met
```

```{r weed count difference of means}
wcountmean2<- emmeans(model.wcount2.best, pairwise ~ Trt_plnt)
wcountmean2

wcountmean3<- emmeans(model.wcount2.best, pairwise ~ Trt_crmp)
wcountmean3

wcountmean4<- emmeans(model.wcount2.best, pairwise ~ Time)
wcountmean4
plot(wcountmean4)
# weed counts low 28DAT
```


### total weed biomass

```{r weed weight data modifications, results='hide', message=FALSE, warning=FALSE}
# table with sums of weed counts & standard deviation for within each combination of rye planting direction, rye crimping/corn planting direction, and time 
wtab2<-subset(dirw, Time=="56DAT") %>%
  group_by(Plot, Rep, Trt_num, Trt_plnt, Trt_crmp) %>%
  summarize(WeightSum=sum(Weight), WSD=sd(Weight))

wtab2trt<- subset(wtab2, Trt_plnt=="E"|Trt_plnt=="N")
```

```{r plot weed weights}
weedw<- ggplot(wtab2, aes(x = Trt_plnt, y = WeightSum)) + 
          geom_boxplot() +
          theme_bw()
print(weedw)

weedw<- ggplot(wtab2, aes(x = Trt_crmp, y = WeightSum)) + 
          geom_boxplot() +
          theme_bw()
print(weedw)

weedw<- ggplot(wtab2, aes(x = Trt_plnt, y = WeightSum, fill = Trt_crmp)) + 
          geom_boxplot() +
          theme_bw()
print(weedw)
# No apparent benefit to perpendicular crimping -- appears almost worse?
```

```{r plot weed weight rep effect, results='hide', message=FALSE, warning=FALSE}
weedwrep<- ggplot(wtab2, aes(x = Rep, y = WeightSum)) +
          geom_boxplot() +
          theme_bw()
print(weedwrep)
# no apparent rep effects

# anova of reps to determine if statistically different
# weedwrep<- anova_test(CountSum ~ Rep, data=wtab2) # not working for some reason
# weedwrep
# 
```

```{r model weed weight trt vs control}
# first test if treatments are different from control
model.wwt1<- lmer(WeightSum ~ Trt_num + ( 1 | Rep), data=wtab2)
summary(model.wwt1)
anova(model.wwt1)

wwtmean1<- emmeans(model.wwt1, pairwise ~ Trt_num)
wwtmean1
# ctrl 1 & 2 diff from all trts
# no trts diff from each other

plot(wwtmean1)
```

```{r model weed weight trt level, results='hide', message=FALSE, warning=FALSE}
# test if treatments are different from each other
model.wwt2<- lmer(WeightSum ~ Trt_plnt * Trt_crmp + ( 1 | Rep), data=wtab2trt)
summary(model.wwt2)
anova(model.wwt2)

isSingular(model.wwt2)

## model reduction
model.wwt2.best<- get_model(lmerTest::step(model.wwt2, reduce.random=F))
summary(model.wwt2.best)
anova(model.wwt2.best)
### best model: WeightSum ~ (1 | Rep)
```

```{r weed weight model assumptions, results='hide', message=FALSE, warning=FALSE}
# check residuals
resid.model.wwt<- resid(model.wwt2.best)
pred.model.wwt<- predict(model.wwt2.best)

# check randomness
plot(pred.model.wwt, resid.model.wwt, ylab="Residuals", xlab="Weed weights", main="Predictecd vs Residuals") # all in line

# check normality
hist(resid.model.wwt, main="Histogram of Residuals", xlab="Weed weights") # almost all same value

qqnorm(resid.model.wwt) 

# Shapiro-Wilk test
shapiro.test(resid.model.wwt)
# test assumptions not met but no trends
```

```{r weed weight difference of means}
# no main effects
```


### correlation btwn rye biomass & weed biomass

```{r}
# need dataframe with rye biomass & weed biomass data
wtab2 # table of weed biomass

# make rye weight data into table
rtab<- dir %>%
  group_by(Plot, Rep, Trt_num, Trt_plnt, Trt_crmp) %>%
  summarize(Rye_wt)

# combine the two tables
rwtab<- merge(wtab2, rtab, by=c("Plot", "Rep", "Trt_num", "Trt_plnt", "Trt_crmp"))
print(rwtab)

# correlate rye biomass & weed biomass
rwplot<- ggplot(rwtab, aes(x = Rye_wt, y = WeightSum, colour=interaction(Trt_plnt,Trt_crmp))) +
  geom_point(size=3) +
  theme_bw()
print(rwplot)

rwplot<- ggplot(rwtab, aes(x = Rye_wt, y = WeightSum, colour=Trt_plnt)) +
  geom_point(size=3) +
  theme_bw()
print(rwplot)

rwplot<- ggplot(rwtab, aes(x = Rye_wt, y = WeightSum, colour=Trt_crmp)) +
  geom_point(size=3) +
  theme_bw()
print(rwplot)

ggscatter(rwtab, x = "Rye_wt", y = "WeightSum", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Rye biomass", ylab = "Weed biomass")
# weakly negative, not significant

cor.test(rwtab$Rye_wt, rwtab$WeightSum, method="pearson")
```


### correlation btwn marketable corn biomass & weed biomass

```{r}
mtab<- dir %>%
  group_by(Plot, Rep, Trt_num, Trt_plnt, Trt_crmp) %>%
  summarize(W_M_wt)

mwtab<- merge(mtab, wtab2, by=c("Plot", "Rep", "Trt_num", "Trt_plnt", "Trt_crmp"))

ggscatter(mwtab, x = "WeightSum", y = "W_M_wt", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Weed biomass", ylab = "Marketable corn biomass") 
# strongly correlated 

cor.test(mwtab$WeightSum, mwtab$W_M_wt, method="pearson")
# R = -0.8, p = 2.35e-6
```


### comparison of broadleaf & grassy weeds

```{r weed type data modifications, results='hide', message=FALSE, warning=FALSE}
typetab<- dirw %>%
  group_by(Plot, Rep, Trt_num, Trt_plnt, Trt_crmp, Time, Type) %>%
  summarize(typeCount=sum(Count))

typetab2<- subset(dirw, Time=="56DAT") %>%
  group_by(Plot, Rep, Trt_num, Trt_plnt, Trt_crmp, Type) %>%
  summarize(typeWeight=sum(Weight))
```

```{r plot weed types -- counts}
type<- ggplot(typetab, aes(x = Trt_plnt, y = typeCount, fill = Type)) + 
          geom_boxplot() +
          theme_bw()
print(type)
# grasses larger in all rye planting directions & ctrl

type<- ggplot(typetab, aes(x = Trt_crmp, y = typeCount, fill = Type)) + 
          geom_boxplot() +
          theme_bw()
print(type)
# grasses larger in all crimping directions

type<- ggplot(typetab, aes(x = Trt_num, y = typeCount, fill = Type)) + 
          geom_boxplot() +
          theme_bw()
print(type)
# grasses larger in all treatments & controls

type<- ggplot(typetab, aes(x = Time, y = typeCount, fill = Type)) + 
          geom_boxplot() +
          theme_bw()
print(type)
# grasses larger at all time periods
```

```{r plot weed type rep effect -- counts, results='hide', message=FALSE, warning=FALSE}
typerep<- ggplot(typetab, aes(x = Rep, y = typeCount)) +
          geom_boxplot() +
          theme_bw()
print(typerep)
# no apparent rep effects

# anova of reps to determine if statistically different
# typerep<- anova_test(typeCount ~ Rep, data=typetab) # not working for some reason
# typerep
# 
```

```{r plot weed types -- weight}
typew<- ggplot(typetab2, aes(x = Trt_plnt, y = typeWeight, fill = Type)) + 
          geom_boxplot() +
          theme_bw()
print(typew)
# grasses larger in all rye planting directions & ctrl

typew<- ggplot(typetab2, aes(x = Trt_crmp, y = typeWeight, fill = Type)) + 
          geom_boxplot() +
          theme_bw()
print(typew)
# grasses larger in all crimping directions

typew<- ggplot(typetab2, aes(x = Trt_num, y = typeWeight, fill = Type)) + 
          geom_boxplot() +
          theme_bw()
print(typew)
# grasses larger in all treatments & controls
```

```{r plot weed type rep effect -- weight, results='hide', message=FALSE, warning=FALSE}
typewrep<- ggplot(typetab2, aes(x = Rep, y = typeWeight)) +
          geom_boxplot() +
          theme_bw()
print(typewrep)
# no apparent rep effects

# anova of reps to determine if statistically different
# typewrep<- anova_test(typeWeight ~ Rep, data=typetab2) # not working for some reason
# typewrep
# 
```